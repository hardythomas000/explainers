<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Universal Setup Sheet â€” How It Works</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEMPLATE: makingsoftware-style explainer
   Reusable structure â€” swap content per project
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #08090c;
  --bg-raised: #0e1017;
  --bg-surface: #13151e;
  --bg-interactive: #181b27;
  --text: #e8eaf0;
  --text-secondary: #8b90a0;
  --text-dim: #4a4e5e;
  --border: #1e2133;
  --border-subtle: #151827;
  --accent: #6c8aff;
  --accent-glow: rgba(108, 138, 255, 0.15);
  --accent2: #ff7b5c;
  --accent3: #5cffa0;
  --accent4: #ffcb5c;
  --accent5: #cb6cff;
  --column: 680px;
  --wide: 900px;
  --gutter: 24px;
  --font: 'Inter', -apple-system, system-ui, sans-serif;
  --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
}

/* â•â•â• PROGRESS BAR â•â•â• */
.progress-bar {
  position: fixed; top: 0; left: 0; z-index: 1000;
  height: 2px; background: var(--accent);
  width: 0%; transition: width 0.1s linear;
  box-shadow: 0 0 8px var(--accent);
}

/* â•â•â• NAV DOTS â•â•â• */
.nav-dots {
  position: fixed; right: 16px; top: 50%; transform: translateY(-50%);
  z-index: 100; display: flex; flex-direction: column; gap: 12px;
}
.nav-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--text-dim); cursor: pointer;
  transition: all 0.3s ease; border: none; padding: 0;
  position: relative;
}
.nav-dot::after {
  content: attr(data-label);
  position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
  background: var(--bg-surface); color: var(--text-secondary);
  padding: 4px 10px; border-radius: 6px; font-size: 0.7em;
  white-space: nowrap; opacity: 0; pointer-events: none;
  transition: opacity 0.2s; border: 1px solid var(--border);
}
.nav-dot:hover::after { opacity: 1; }
.nav-dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); transform: scale(1.3); }

@media (max-width: 768px) { .nav-dots { display: none; } }

/* â•â•â• LAYOUT â•â•â• */
.col { max-width: var(--column); margin: 0 auto; padding: 0 var(--gutter); }
.col-wide { max-width: var(--wide); margin: 0 auto; padding: 0 var(--gutter); }

/* â•â•â• REVEAL ANIMATION â•â•â• */
.reveal {
  opacity: 0; transform: translateY(30px);
  transition: opacity 0.7s cubic-bezier(0.16, 1, 0.3, 1),
              transform 0.7s cubic-bezier(0.16, 1, 0.3, 1);
}
.reveal.visible { opacity: 1; transform: translateY(0); }
.reveal.delay-1 { transition-delay: 0.1s; }
.reveal.delay-2 { transition-delay: 0.2s; }
.reveal.delay-3 { transition-delay: 0.3s; }
.reveal.delay-4 { transition-delay: 0.4s; }

/* â•â•â• CHAPTER SYSTEM â•â•â• */
.chapter {
  padding: 100px 0;
  min-height: 60vh;
  position: relative;
}
.chapter + .chapter { border-top: 1px solid var(--border-subtle); }

.chapter-label {
  font-size: 0.65em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 3px;
  color: var(--accent); margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.chapter-label::before {
  content: ''; width: 20px; height: 1px; background: var(--accent);
}

.chapter h2 {
  font-size: clamp(1.8em, 5vw, 2.8em);
  font-weight: 800; letter-spacing: -0.03em;
  line-height: 1.15; margin-bottom: 20px;
  background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

.chapter .lead {
  font-size: 1.1em; color: var(--text-secondary);
  line-height: 1.7; max-width: 540px;
}

/* â•â•â• HERO â•â•â• */
.hero {
  min-height: 100vh; display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  text-align: center; position: relative;
  padding: 60px var(--gutter);
  overflow: hidden;
}

.hero-bg {
  position: absolute; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 60% 40% at 50% 40%, rgba(108, 138, 255, 0.08) 0%, transparent 70%),
    radial-gradient(ellipse 40% 30% at 30% 70%, rgba(255, 123, 92, 0.04) 0%, transparent 60%);
}

.hero-grid {
  position: absolute; inset: 0; z-index: 0;
  background-image:
    linear-gradient(var(--border-subtle) 1px, transparent 1px),
    linear-gradient(90deg, var(--border-subtle) 1px, transparent 1px);
  background-size: 60px 60px;
  mask-image: radial-gradient(ellipse 70% 50% at 50% 50%, black 20%, transparent 70%);
  -webkit-mask-image: radial-gradient(ellipse 70% 50% at 50% 50%, black 20%, transparent 70%);
  opacity: 0.5;
}

.hero-content { position: relative; z-index: 1; max-width: 700px; }

.hero-badge {
  display: inline-flex; align-items: center; gap: 8px;
  background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: 100px; padding: 6px 16px 6px 8px;
  font-size: 0.78em; color: var(--text-secondary);
  margin-bottom: 32px;
}
.hero-badge-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--accent3); box-shadow: 0 0 6px var(--accent3);
  animation: pulse-dot 2s ease infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 1; } 50% { opacity: 0.4; }
}

.hero h1 {
  font-size: clamp(2.2em, 7vw, 4em);
  font-weight: 900; letter-spacing: -0.04em;
  line-height: 1.05; margin-bottom: 24px;
}
.hero h1 .highlight {
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent5) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero-sub {
  font-size: 1.15em; color: var(--text-secondary);
  line-height: 1.6; max-width: 520px; margin: 0 auto 40px;
}

.hero-stats {
  display: flex; gap: 32px; justify-content: center; flex-wrap: wrap;
}
.hero-stat {
  text-align: center;
}
.hero-stat-val {
  font-size: 1.8em; font-weight: 800; color: var(--text);
  font-family: var(--mono);
}
.hero-stat-label {
  font-size: 0.72em; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 1px;
}

.scroll-hint {
  position: absolute; bottom: 32px; left: 50%; transform: translateX(-50%);
  color: var(--text-dim); font-size: 0.72em; text-align: center;
  animation: float 2s ease-in-out infinite;
}
.scroll-hint svg { display: block; margin: 6px auto 0; }
@keyframes float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(6px); } }

/* â•â•â• PROBLEM/SOLUTION â•â•â• */
.comparison {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 16px; margin-top: 40px;
}
@media (max-width: 640px) { .comparison { grid-template-columns: 1fr; } }

.compare-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 16px; padding: 28px;
  position: relative; overflow: hidden;
}
.compare-card.bad { border-color: rgba(255, 100, 80, 0.2); }
.compare-card.good { border-color: rgba(92, 255, 160, 0.2); }

.compare-card .badge {
  font-size: 0.65em; font-weight: 700; text-transform: uppercase;
  letter-spacing: 2px; margin-bottom: 12px;
}
.compare-card.bad .badge { color: var(--accent2); }
.compare-card.good .badge { color: var(--accent3); }

.compare-card h3 {
  font-size: 1.3em; font-weight: 700; margin-bottom: 8px;
}
.compare-card p { color: var(--text-secondary); font-size: 0.92em; }

.compare-card .time {
  font-family: var(--mono); font-size: 2em; font-weight: 800;
  margin-top: 16px;
}
.compare-card.bad .time { color: var(--accent2); }
.compare-card.good .time { color: var(--accent3); }

/* â•â•â• PIPELINE â•â•â• */
.pipeline {
  display: flex; align-items: stretch; gap: 0;
  margin: 48px 0; overflow-x: auto;
  padding-bottom: 8px;
}
.pipe-stage {
  flex: 1; min-width: 160px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  padding: 24px 20px;
  text-align: center;
  position: relative;
  transition: all 0.3s ease;
  cursor: default;
}
.pipe-stage:first-child { border-radius: 14px 0 0 14px; }
.pipe-stage:last-child { border-radius: 0 14px 14px 0; }

.pipe-stage:hover {
  background: var(--bg-interactive);
  border-color: var(--accent);
  z-index: 1;
}

.pipe-stage .icon {
  font-size: 1.8em; margin-bottom: 8px;
  display: block;
}
.pipe-stage h4 {
  font-size: 0.85em; font-weight: 700; margin-bottom: 4px;
}
.pipe-stage p {
  font-size: 0.72em; color: var(--text-dim); line-height: 1.4;
}

.pipe-arrow {
  display: flex; align-items: center;
  color: var(--text-dim); font-size: 1.2em;
  flex-shrink: 0; padding: 0 2px;
}

/* â•â•â• INTERACTIVE G-CODE EXPLORER â•â•â• */
.explorer-container {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin: 48px 0;
}

.explorer-toolbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 20px;
  background: var(--bg-interactive);
  border-bottom: 1px solid var(--border);
}
.explorer-toolbar-title {
  font-size: 0.78em; font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: 1px;
}
.explorer-controls { display: flex; gap: 6px; }

.ex-btn {
  width: 32px; height: 32px; border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg-surface);
  color: var(--text-secondary);
  cursor: pointer; font-size: 0.85em;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.ex-btn:hover { border-color: var(--accent); color: var(--accent); }
.ex-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

.ex-btn-wide {
  width: auto; padding: 0 14px;
  font-size: 0.75em; font-weight: 600;
  gap: 4px;
}

.explorer-body {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0;
}

@media (min-width: 768px) {
  .explorer-body {
    grid-template-columns: 1fr 300px;
  }
}

/* G-code listing */
.gcode-listing {
  max-height: 500px;
  overflow-y: auto;
  font-family: var(--mono);
  font-size: 0.82em;
  line-height: 1.8;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}
.gcode-listing::-webkit-scrollbar { width: 6px; }
.gcode-listing::-webkit-scrollbar-track { background: transparent; }
.gcode-listing::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.gc-line {
  display: flex; padding: 1px 20px;
  cursor: pointer; border-left: 3px solid transparent;
  transition: all 0.12s ease;
}
.gc-line:hover { background: var(--bg-interactive); }
.gc-line.active {
  background: rgba(108, 138, 255, 0.08);
  border-left-color: var(--accent);
}
.gc-line.past { opacity: 0.35; }

.gc-ln {
  color: var(--text-dim); min-width: 30px;
  text-align: right; margin-right: 16px;
  user-select: none; font-size: 0.85em;
}
.gc-code { white-space: pre; }

/* Syntax colors */
.gc-line.t-meta .gc-code { color: var(--text-dim); }
.gc-line.t-header .gc-code { color: var(--accent5); }
.gc-line.t-comment .gc-code { color: #a78bfa; }
.gc-line.t-tool .gc-code { color: var(--accent); font-weight: 600; }
.gc-line.t-spindle .gc-code { color: var(--accent4); }
.gc-line.t-coolant .gc-code { color: #22d3ee; }
.gc-line.t-offset .gc-code { color: #f472b6; }
.gc-line.t-feed .gc-code { color: var(--accent3); }
.gc-line.t-rapid .gc-code { color: var(--text-dim); }
.gc-line.t-cut .gc-code { color: var(--text); }
.gc-line.t-arc .gc-code { color: #fb923c; }
.gc-line.t-end .gc-code { color: var(--text-dim); font-weight: 600; }

/* State sidebar */
.state-sidebar {
  border-top: 1px solid var(--border);
  padding: 0;
  display: flex; flex-direction: column;
}

@media (min-width: 768px) {
  .state-sidebar {
    border-top: none;
    border-left: 1px solid var(--border);
  }
}

.state-sidebar-header {
  font-size: 0.68em; font-weight: 600;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--text-dim); padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}

.state-cells { display: grid; grid-template-columns: 1fr 1fr; gap: 0; flex: 1; }

.st-cell {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border-subtle);
  border-right: 1px solid var(--border-subtle);
  transition: background 0.2s;
}
.st-cell:nth-child(2n) { border-right: none; }

.st-cell .st-val {
  font-family: var(--mono); font-weight: 600;
  font-size: 0.95em; color: var(--text);
  transition: color 0.2s;
}
.st-cell .st-lbl {
  font-size: 0.62em; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.5px;
  margin-top: 2px;
}
.st-cell.changed {
  background: rgba(108, 138, 255, 0.06);
}
.st-cell.changed .st-val { color: var(--accent); }

/* Explain panel */
.explain-panel {
  border-top: 1px solid var(--border);
  padding: 16px 20px;
  font-size: 0.88em;
  line-height: 1.6;
  color: var(--text-secondary);
  min-height: 72px;
  display: none;
}
.explain-panel.visible { display: block; }

.explain-tag {
  display: inline-block;
  padding: 2px 10px; border-radius: 5px;
  font-size: 0.75em; font-weight: 700;
  margin-right: 6px; vertical-align: middle;
}
.tag-phase1 { background: rgba(203, 108, 255, 0.15); color: var(--accent5); }
.tag-state { background: rgba(108, 138, 255, 0.15); color: var(--accent); }
.tag-emit { background: rgba(255, 203, 92, 0.15); color: var(--accent4); }
.tag-heuristic { background: rgba(92, 255, 160, 0.15); color: var(--accent3); }
.tag-ignore { background: rgba(74, 78, 94, 0.2); color: var(--text-dim); }

/* â•â•â• EXTRACTED TABLE â•â•â• */
.data-table-wrap {
  margin: 32px 0;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
}
.data-table-header {
  padding: 12px 20px;
  font-size: 0.68em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--text-dim);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
}
.data-table-header::before {
  content: ''; width: 3px; height: 12px;
  background: var(--accent4); border-radius: 2px;
}

.data-table { width: 100%; border-collapse: collapse; }
.data-table th {
  padding: 10px 14px; text-align: left;
  font-size: 0.7em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px;
  color: var(--text-dim);
  background: var(--bg-interactive);
  border-bottom: 1px solid var(--border);
}
.data-table td {
  padding: 10px 14px;
  font-family: var(--mono); font-size: 0.82em;
  border-bottom: 1px solid var(--border-subtle);
  color: var(--text);
}
.data-table tr:last-child td { border-bottom: none; }
.data-table tr.building td { color: var(--accent); }
.data-table tr.future td { opacity: 0.15; }
.data-table .empty { color: var(--text-dim); font-family: var(--font); text-align: center; padding: 24px; }

/* â•â•â• TERM DEFINITIONS â•â•â• */
.term {
  color: var(--accent);
  border-bottom: 1px dashed rgba(108, 138, 255, 0.4);
  cursor: help; position: relative;
}
.term:hover .term-tip {
  opacity: 1; transform: translateY(0); pointer-events: auto;
}
.term-tip {
  position: absolute; bottom: calc(100% + 8px); left: 50%;
  transform: translateX(-50%) translateY(4px);
  background: var(--bg-interactive);
  border: 1px solid var(--border);
  border-radius: 10px; padding: 10px 14px;
  font-size: 0.82em; color: var(--text-secondary);
  white-space: normal; width: 260px;
  opacity: 0; pointer-events: none;
  transition: all 0.2s ease;
  z-index: 50; line-height: 1.5;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}

/* â•â•â• CONCEPT CARDS â•â•â• */
.concept-grid {
  display: grid; grid-template-columns: 1fr;
  gap: 16px; margin: 40px 0;
}
@media (min-width: 640px) {
  .concept-grid.cols-2 { grid-template-columns: 1fr 1fr; }
  .concept-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
}

.concept-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 14px; padding: 24px;
  transition: border-color 0.3s;
}
.concept-card:hover { border-color: var(--accent); }
.concept-card .cc-icon { font-size: 1.5em; margin-bottom: 10px; }
.concept-card h4 { font-size: 0.95em; font-weight: 700; margin-bottom: 6px; }
.concept-card p { font-size: 0.82em; color: var(--text-secondary); line-height: 1.5; }

/* â•â•â• FEED HEURISTIC VISUAL â•â•â• */
.heuristic-demo {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 16px; overflow: hidden;
  margin: 40px 0;
}
.heuristic-header {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
  font-size: 0.68em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--text-dim);
}
.heuristic-header::before {
  content: ''; width: 3px; height: 12px;
  background: var(--accent3); border-radius: 2px;
}

.heuristic-body { padding: 24px; }

.heuristic-lines { display: flex; flex-direction: column; gap: 4px; }
.h-line {
  font-family: var(--mono); font-size: 0.82em;
  padding: 8px 14px; border-radius: 8px;
  display: flex; align-items: center; gap: 12px;
  transition: all 0.3s;
}
.h-line .h-code { flex: 1; }
.h-line .h-verdict {
  font-family: var(--font); font-size: 0.8em;
  font-weight: 600; white-space: nowrap;
}
.h-line.skip {
  background: rgba(255, 100, 80, 0.06);
  border: 1px solid rgba(255, 100, 80, 0.12);
}
.h-line.skip .h-verdict { color: var(--accent2); }
.h-line.skip .h-code { color: var(--text-secondary); }
.h-line.capture {
  background: rgba(92, 255, 160, 0.06);
  border: 1px solid rgba(92, 255, 160, 0.12);
}
.h-line.capture .h-verdict { color: var(--accent3); }
.h-line.capture .h-code { color: var(--text); }

.heuristic-explain {
  margin-top: 16px; padding: 14px;
  background: rgba(108, 138, 255, 0.05);
  border-radius: 10px;
  font-size: 0.85em; color: var(--text-secondary);
  line-height: 1.6;
}
.heuristic-explain strong { color: var(--text); }

/* â•â•â• ARCHITECTURE VISUAL â•â•â• */
.arch-tree {
  font-family: var(--mono); font-size: 0.82em;
  line-height: 2; margin: 32px 0;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 24px;
}
.arch-file {
  display: flex; gap: 12px; align-items: baseline;
  padding: 2px 0;
}
.arch-file .af-tree { color: var(--text-dim); user-select: none; }
.arch-file .af-name { color: var(--accent); font-weight: 600; }
.arch-file .af-desc { color: var(--text-dim); font-family: var(--font); font-size: 0.9em; }
.arch-file .af-lines {
  font-family: var(--font); font-size: 0.78em;
  color: var(--text-dim); background: var(--bg-interactive);
  padding: 1px 8px; border-radius: 4px;
}

/* â•â•â• CALLOUT â•â•â• */
.callout {
  margin: 32px 0; padding: 20px 24px;
  border-left: 3px solid var(--accent);
  background: rgba(108, 138, 255, 0.04);
  border-radius: 0 12px 12px 0;
  font-size: 0.92em; color: var(--text-secondary);
}
.callout strong { color: var(--text); }

/* â•â•â• CODE INLINE â•â•â• */
code {
  font-family: var(--mono); font-size: 0.88em;
  background: var(--bg-interactive);
  padding: 2px 7px; border-radius: 5px;
  color: var(--accent);
}

/* â•â•â• 3D VIEWER â•â•â• */
.viewer-container {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin: 40px 0;
}
.viewer-toolbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 20px;
  background: var(--bg-interactive);
  border-bottom: 1px solid var(--border);
}
.viewer-toolbar-title {
  font-size: 0.78em; font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: 1px;
}
.viewer-controls { display: flex; gap: 6px; }
.viewer-btn.active-view { background: var(--accent); color: white; border-color: var(--accent); }

#viewer3d {
  width: 100%; height: 420px;
  display: block; cursor: grab;
  background: #0a0c12;
}
#viewer3d:active { cursor: grabbing; }

.viewer-legend {
  display: flex; gap: 16px; flex-wrap: wrap;
  padding: 10px 20px;
  border-top: 1px solid var(--border);
  font-size: 0.72em; color: var(--text-secondary);
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-swatch {
  width: 10px; height: 10px; border-radius: 3px;
  display: inline-block;
}

/* â•â•â• FOOTER â•â•â• */
.footer {
  text-align: center; padding: 60px var(--gutter);
  color: var(--text-dim); font-size: 0.78em;
  border-top: 1px solid var(--border-subtle);
}
.footer a { color: var(--text-secondary); text-decoration: none; }
.footer a:hover { color: var(--accent); }
</style>
</head>
<body>

<div class="progress-bar" id="progressBar"></div>

<nav class="nav-dots" id="navDots">
  <button class="nav-dot active" data-label="Top" onclick="scrollToChapter(0)"></button>
  <button class="nav-dot" data-label="Problem" onclick="scrollToChapter(1)"></button>
  <button class="nav-dot" data-label="Pipeline" onclick="scrollToChapter(2)"></button>
  <button class="nav-dot" data-label="Parser" onclick="scrollToChapter(3)"></button>
  <button class="nav-dot" data-label="Feed Heuristic" onclick="scrollToChapter(4)"></button>
  <button class="nav-dot" data-label="3D Datum View" onclick="scrollToChapter(5)"></button>
  <button class="nav-dot" data-label="Architecture" onclick="scrollToChapter(6)"></button>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAPTER 0: HERO
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="hero chapter" id="ch0">
  <div class="hero-bg"></div>
  <div class="hero-grid"></div>
  <div class="hero-content">
    <div class="hero-badge reveal">
      <span class="hero-badge-dot"></span>
      A side project by Hardy &middot; built with Claude
    </div>
    <h1 class="reveal delay-1">Raw G-code in.<br><span class="highlight">Beautiful setup sheets out.</span></h1>
    <p class="hero-sub reveal delay-2">
      Drop in any .nc file â€” Mastercam, Hypermill, hand-written â€” and get a clean, customizable, print-ready setup sheet. Automated. Consistent. Free.
    </p>
    <div class="hero-stats reveal delay-3">
      <div class="hero-stat">
        <div class="hero-stat-val">~900</div>
        <div class="hero-stat-label">Lines of C#</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-val">6</div>
        <div class="hero-stat-label">Source Files</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-val">2</div>
        <div class="hero-stat-label">Phases</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-val">&lt;1s</div>
        <div class="hero-stat-label">Parse Time</div>
      </div>
    </div>
  </div>
  <div class="scroll-hint">
    Scroll to explore
    <svg width="16" height="24" viewBox="0 0 16 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M8 4v12M4 12l4 4 4-4"/>
    </svg>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAPTER 1: THE PROBLEM
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="chapter" id="ch1">
  <div class="col">
    <div class="chapter-label reveal">01 â€” The Problem</div>
    <h2 class="reveal delay-1">Setup sheets are<br>a time sink</h2>
    <p class="lead reveal delay-2">
      You know the drill. CAM software can export a setup sheet, but it looks like it was made in 1998 and only covers that one post. Multiple CAM systems and machine brands? Manual reformatting. Then the machinist requests a change â€” totally expected â€” and now you're rebuilding the setup sheet on top of updating the program. Every revision, every time.
    </p>

    <div class="comparison reveal delay-3">
      <div class="compare-card bad">
        <div class="badge">The Status Quo</div>
        <h3>Edit, Export, Edit Again</h3>
        <p>Your CAM spits out a basic sheet â€” but it looks rough and only covers that one post. Different CAM? Different machine? Manual reformatting. Then the machinist requests a change (as they should), you update the program, and now you're rebuilding the setup sheet too. Across a busy shop with Mastercam, Hypermill, Haas, and Mazak, it adds up. And the automated alternatives from private resellers? Thousands of dollars.</p>
        <div class="time">10â€“30 min per revision</div>
      </div>
      <div class="compare-card good">
        <div class="badge">This Tool</div>
        <h3>Regenerate in Seconds</h3>
        <p>Reads the G-code directly â€” doesn't matter which CAM generated it. Machinist wants a change? Update the program, hit Generate again, done. Same clean output every time. Merges your tool library. Consistent, customizable, print-ready. And it's free.</p>
        <div class="time">&lt; 3 sec to regenerate</div>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAPTER 2: THE PIPELINE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="chapter" id="ch2">
  <div class="col-wide">
    <div class="chapter-label reveal">02 â€” Data Flow</div>
    <h2 class="reveal delay-1">From G-code<br>to setup sheet</h2>
    <p class="lead reveal delay-2">
      Three stages. Two inputs. One output.
    </p>

    <div class="pipeline reveal delay-3">
      <div class="pipe-stage">
        <span class="icon">ğŸ“„</span>
        <h4>.nc File</h4>
        <p>Raw G-code from Mastercam, Hypermill, or hand-written</p>
      </div>
      <div class="pipe-arrow">â†’</div>
      <div class="pipe-stage">
        <span class="icon">ğŸ”</span>
        <h4>Parser</h4>
        <p>Two-phase state machine extracts tools, speeds, feeds, coolant</p>
      </div>
      <div class="pipe-arrow">â†’</div>
      <div class="pipe-stage">
        <span class="icon">ğŸ”—</span>
        <h4>Merge</h4>
        <p>Combines parsed data with CSV tool library (diameters, holders)</p>
      </div>
      <div class="pipe-arrow">â†’</div>
      <div class="pipe-stage">
        <span class="icon">ğŸ“Š</span>
        <h4>.xlsx Output</h4>
        <p>Print-ready Excel with header, toolpaths, tool list, and images</p>
      </div>
    </div>

    <div class="callout reveal delay-4">
      <strong>The tool library is optional.</strong> If you don't have a CSV, the setup sheet still generates with all G-code data. Missing supplementary fields (diameter, holder, stickout) are highlighted yellow for manual entry.
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAPTER 3: THE PARSER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="chapter" id="ch3">
  <div class="col-wide">
    <div class="chapter-label reveal">03 â€” The Parser</div>
    <h2 class="reveal delay-1">Step through<br>actual G-code</h2>
    <p class="lead reveal delay-2">
      Click any line to see what the parser does. Watch state accumulate across tool blocks. See exactly when data gets captured â€” and when it's intentionally skipped.
    </p>

    <!-- Two-phase explanation -->
    <div class="concept-grid cols-2 reveal delay-3">
      <div class="concept-card">
        <div class="cc-icon" style="color:var(--accent5)">â‘ </div>
        <h4>Phase 1 â€” Pre-scan</h4>
        <p>Reads header comments to find tool descriptions. Mastercam writes them as pipe-delimited lines: <code>( T1 | 63MM FACEMILL | H1 )</code>. Builds a lookup table before the real parsing begins.</p>
      </div>
      <div class="concept-card">
        <div class="cc-icon" style="color:var(--accent)">â‘¡</div>
        <h4>Phase 2 â€” State Machine</h4>
        <p>Line-by-line walk tracking modal G-codes, spindle, coolant, offsets, and feed. When it hits a tool change (T## M6) or program end (M30), it <em>emits</em> the collected state as a tool record.</p>
      </div>
    </div>

    <!-- Interactive Explorer -->
    <div class="explorer-container reveal" id="explorerContainer">
      <div class="explorer-toolbar">
        <span class="explorer-toolbar-title">Interactive G-Code Explorer</span>
        <div class="explorer-controls">
          <button class="ex-btn" onclick="resetExplorer()" title="Reset">â†º</button>
          <button class="ex-btn" onclick="stepPrev()" title="Previous">â—€</button>
          <button class="ex-btn" onclick="stepNext()" title="Next">â–¶</button>
          <button class="ex-btn ex-btn-wide" id="playBtn" onclick="togglePlay()">â–¶ Auto</button>
        </div>
      </div>
      <div class="explorer-body">
        <div class="gcode-listing" id="gcodeListing"></div>
        <div class="state-sidebar">
          <div class="state-sidebar-header">Parser State</div>
          <div class="state-cells" id="stateCells"></div>
        </div>
      </div>
      <div class="explain-panel" id="explainPanel"></div>
    </div>

    <!-- Extracted data table -->
    <div class="data-table-wrap reveal">
      <div class="data-table-header">Extracted Tool Data</div>
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th><th>Tool</th><th>Operation</th><th>RPM</th><th>Feed</th><th>Coolant</th><th>Offset</th><th>Min Z</th>
          </tr>
        </thead>
        <tbody id="extractedBody">
          <tr><td colspan="8" class="empty">Tap a line above to begin</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAPTER 4: FEED HEURISTIC
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="chapter" id="ch4">
  <div class="col">
    <div class="chapter-label reveal">04 â€” The Feed Heuristic</div>
    <h2 class="reveal delay-1">Not all F-words<br>are equal</h2>
    <p class="lead reveal delay-2">
      G-code has one <code>F</code> word for feed rate â€” but it means different things depending on context. A plunge feed (Z-only) is much slower than a lateral cutting feed (X/Y). Setup sheets need the cutting feed. The parser uses a simple heuristic to tell them apart.
    </p>

    <div class="heuristic-demo reveal delay-3">
      <div class="heuristic-header">Feed Detection Logic</div>
      <div class="heuristic-body">
        <div class="heuristic-lines">
          <div class="h-line skip">
            <span class="h-code">G1 Z-0.5 <strong>F200.</strong></span>
            <span class="h-verdict">âŠ˜ Skipped â€” Z only</span>
          </div>
          <div class="h-line capture">
            <span class="h-code">G1 X100. Y50. <strong>F2500.</strong></span>
            <span class="h-verdict">âœ“ Captured â€” has X/Y</span>
          </div>
          <div class="h-line skip">
            <span class="h-code">G1 Z-5. <strong>F150.</strong></span>
            <span class="h-verdict">âŠ˜ Skipped â€” Z only</span>
          </div>
          <div class="h-line capture">
            <span class="h-code">G1 X80. <strong>F1200.</strong></span>
            <span class="h-verdict">âœ“ Captured â€” has X</span>
          </div>
        </div>
        <div class="heuristic-explain">
          <strong>Rule:</strong> Only capture <code>F</code> when the line contains <code>X</code> or <code>Y</code> motion. If no lateral feed is ever found, fall back to the first <code>F</code> encountered (better than nothing). Once a lateral feed is captured, stop looking â€” the first one is almost always the primary cutting feed.
        </div>
      </div>
    </div>

    <div class="callout reveal delay-4">
      <strong>Why this matters:</strong> If you record F200 (the plunge feed) on the setup sheet instead of F2500 (the cutting feed), the machinist checking the program will think something is wrong. The setup sheet should show the feed rate the machine will spend 90% of its time at.
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAPTER 5: 3D DATUM VIEW
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="chapter" id="ch5">
  <div class="col-wide">
    <div class="chapter-label reveal">05 â€” What's Next</div>
    <h2 class="reveal delay-1">Kill the<br>screengrab</h2>
    <p class="lead reveal delay-2">
      Today, setup sheets show datum locations with pasted screenshots from the CAM software. Flat, low-res, one angle only. If the machinist needs to see the other side? Too bad. The next step: an interactive 3D view of the stock, fixtures, and datum origins â€” right inside the setup sheet.
    </p>

    <div class="callout reveal delay-3" style="border-left-color: var(--accent4);">
      <strong>The idea:</strong> Parse work offsets (G54, G55, G59...) from the G-code, then render an interactive 3D view showing where each datum sits relative to the stock and fixturing. The machinist at the PC can orbit, zoom, and inspect â€” no more guessing from a cropped screenshot. Drag the view below.
    </div>

    <!-- 3D viewer -->
    <div class="viewer-container reveal delay-3" id="viewerContainer">
      <div class="viewer-toolbar">
        <span class="viewer-toolbar-title">Interactive Setup View</span>
        <div class="viewer-controls">
          <button class="ex-btn ex-btn-wide viewer-btn" data-view="iso" onclick="setView('iso')">Iso</button>
          <button class="ex-btn ex-btn-wide viewer-btn" data-view="top" onclick="setView('top')">Top</button>
          <button class="ex-btn ex-btn-wide viewer-btn" data-view="front" onclick="setView('front')">Front</button>
          <button class="ex-btn ex-btn-wide viewer-btn" data-view="right" onclick="setView('right')">Right</button>
        </div>
      </div>
      <canvas id="viewer3d"></canvas>
      <div class="viewer-legend">
        <span class="legend-item"><span class="legend-swatch" style="background:#6c8aff"></span>Stock</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#4a4e5e"></span>Vise</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#ff5c5c"></span>X axis</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#5cff5c"></span>Y axis</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#5c8aff"></span>Z axis</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#ffcb5c"></span>G54</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#cb6cff"></span>G55</span>
      </div>
    </div>

    <div class="concept-grid cols-2 reveal delay-4">
      <div class="concept-card">
        <div class="cc-icon" style="color:var(--accent2)">ğŸ“¸</div>
        <h4>Screenshots Today</h4>
        <p>Static, low-res, one angle. Can't rotate. Can't zoom in on a feature. Cropped wrong half the time. Different CAM systems paste differently. Some don't even include datum markers.</p>
      </div>
      <div class="concept-card">
        <div class="cc-icon" style="color:var(--accent3)">ğŸ”„</div>
        <h4>3D View Tomorrow</h4>
        <p>Orbit and zoom. See every datum origin with its offset label. Stock dimensions visible. Fixture positions clear. Works on any PC with a browser â€” no CAM license needed for the machinist to inspect.</p>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAPTER 6: ARCHITECTURE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="chapter" id="ch6">
  <div class="col">
    <div class="chapter-label reveal">06 â€” Architecture</div>
    <h2 class="reveal delay-1">Six files.<br>No abstractions.</h2>
    <p class="lead reveal delay-2">
      No interfaces. No inheritance hierarchies. No dependency injection. Just static methods, records, and one WinForms form. The kind of code you can understand in an afternoon.
    </p>

    <div class="arch-tree reveal delay-3">
      <div class="arch-file">
        <span class="af-tree">src/</span>
      </div>
      <div class="arch-file">
        <span class="af-tree">&nbsp;&nbsp;â”œâ”€</span>
        <span class="af-name">Models.cs</span>
        <span class="af-lines">~85 lines</span>
        <span class="af-desc">Records + enums. All data shapes.</span>
      </div>
      <div class="arch-file">
        <span class="af-tree">&nbsp;&nbsp;â”œâ”€</span>
        <span class="af-name">GCodeParser.cs</span>
        <span class="af-lines">~500 lines</span>
        <span class="af-desc">Two-phase parser. The brain.</span>
      </div>
      <div class="arch-file">
        <span class="af-tree">&nbsp;&nbsp;â”œâ”€</span>
        <span class="af-name">ToolLibraryImporter.cs</span>
        <span class="af-lines">~120 lines</span>
        <span class="af-desc">CSV reader. RFC 4180 compliant.</span>
      </div>
      <div class="arch-file">
        <span class="af-tree">&nbsp;&nbsp;â”œâ”€</span>
        <span class="af-name">ExcelSetupSheetGenerator.cs</span>
        <span class="af-lines">~400 lines</span>
        <span class="af-desc">ClosedXML output. Sections, images, print layout.</span>
      </div>
      <div class="arch-file">
        <span class="af-tree">&nbsp;&nbsp;â”œâ”€</span>
        <span class="af-name">MainForm.cs</span>
        <span class="af-lines">~300 lines</span>
        <span class="af-desc">WinForms GUI. File pickers, auto-detect.</span>
      </div>
      <div class="arch-file">
        <span class="af-tree">&nbsp;&nbsp;â””â”€</span>
        <span class="af-name">Program.cs</span>
        <span class="af-lines">~12 lines</span>
        <span class="af-desc">Entry point. That's it.</span>
      </div>
    </div>

    <div class="concept-grid cols-3 reveal delay-4">
      <div class="concept-card">
        <h4>No Inheritance</h4>
        <p>G-code dialects differ only in comments. A single <code>switch</code> on <code>CommentStyle</code> handles it â€” not a class hierarchy.</p>
      </div>
      <div class="concept-card">
        <h4>Records, Not Classes</h4>
        <p>C# records for immutable data. <code>ParsedToolChange</code>, <code>ToolLibraryEntry</code>, <code>MachineConfig</code> â€” value semantics, no mutation bugs.</p>
      </div>
      <div class="concept-card">
        <h4>Dictionary Merge</h4>
        <p>Tool library data merges inside the Excel generator via dictionary lookup. No separate merge layer. Optional by design.</p>
      </div>
    </div>
  </div>
</section>

<footer class="footer">
  <p>Built by Hardy Thomas with <a href="https://claude.ai/claude-code">Claude Code</a> &middot; C# / .NET 8 / ClosedXML</p>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// G-CODE DATA â€” each entry:
// [text, type, explanation, tag, stateChanges]
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LINES = [
["%", "meta", "Program start marker â€” standard G-code delimiter.", "ignore", null],
["O1001 (26C49050-TR01_REV-A-00 OP1)", "meta", "Program number and filename. The GUI extracts part number and revision from this using a regex.", "ignore", null],
["( T1 | 63MM FACEMILL | H1 | XY STL 0. | Z STL .1 )", "header", "<span class='explain-tag tag-phase1'>Phase 1</span> Pre-scan finds this Mastercam pipe-delimited comment. Stores: T1 â†’ '63MM FACEMILL'.", "phase1", null],
["( T2 | 16MM ENDMILL | H2 | XY STL 0. | Z STL 0. )", "header", "<span class='explain-tag tag-phase1'>Phase 1</span> Stores: T2 â†’ '16MM ENDMILL'.", "phase1", null],
["( T5 | 10MM BALLNOSE | H5 | XY STL 0. | Z STL 0. )", "header", "<span class='explain-tag tag-phase1'>Phase 1</span> Stores: T5 â†’ '10MM BALLNOSE'. All three descriptions captured before real parsing begins.", "phase1", null],
["N100 G21", "meta", "Metric mode (millimeters). Parser doesn't track this â€” it's a machine setup code.", "ignore", null],
["N110 G0 G17 G40 G49 G80 G90", "meta", "Safety line â€” cancels tool comp (G40), length comp (G49), canned cycles (G80). Standard boilerplate.", "ignore", null],
["( FACING )", "comment", "<span class='explain-tag tag-state'>State</span> Standalone comment captured as pending operation name. Will attach to the next tool change.", "state", {pendingOp: "FACING"}],
["N120 T1 M6", "tool", "<span class='explain-tag tag-emit'>Emit</span> Tool change! T1 + M6 on same line. Parser starts a new tool block â€” resets all state. Pending comment 'FACING' becomes this tool's operation name.", "emit", {tool: "T1", op: "FACING", rpm: "â€”", feed: "â€”", coolant: "Off", offset: "â€”", height: "â€”", minZ: "â€”", dir: "â€”", iVal: "â€”", jVal: "â€”"}],
["N130 G0 G90 G54 X0. Y0.", "offset", "<span class='explain-tag tag-state'>State</span> Rapid to start position. G54 work offset captured. G0 = rapid mode.", "state", {offset: "G54"}],
["N140 S8000 M3", "spindle", "<span class='explain-tag tag-state'>State</span> Spindle ON â€” 8000 RPM clockwise (M3).", "state", {rpm: "8000", dir: "CW"}],
["N150 G43 H1 Z50. M8", "coolant", "<span class='explain-tag tag-state'>State</span> G43 H1 = height offset applied. M8 = flood coolant ON. Z50 is clearance â€” not cutting.", "state", {height: "H1", coolant: "Flood"}],
["N160 G0 Z2.", "rapid", "Rapid approach to 2mm above part. G0 is still modal â€” Z not tracked as cutting depth.", "ignore", null],
["N170 G1 Z-0.5 F200.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> Plunge to Z-0.5 at F200. But no X or Y on this line â€” parser stores as fallback only. Lateral heuristic waits for a real cutting move.", "heuristic", {minZ: "-0.5"}],
["N180 G1 X100. Y50. F2500.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> <strong>Lateral feed captured!</strong> X and Y present â€” F2500 is the real cutting feed. This is what goes on the setup sheet.", "heuristic", {feed: "F2500"}],
["N190 G1 X0. Y0.", "cut", "Continue cutting. Feed is modal (still 2500). No new state changes.", "ignore", null],
["N200 G0 Z50.", "rapid", "Rapid retract to clearance.", "ignore", null],
["N210 M5 M9", "meta", "Spindle stop + coolant off. Parser ignores M5 â€” records the running direction, not the stop.", "ignore", null],
["( POCKET )", "comment", "<span class='explain-tag tag-state'>State</span> Standalone comment: 'POCKET' stored as pending operation name.", "state", {pendingOp: "POCKET"}],
["N220 T2 M6", "tool", "<span class='explain-tag tag-emit'>Emit</span> Tool change to T2! Parser EMITS T1 data (FACING, 8000 RPM, F2500, Flood, Z-0.5). Then resets for T2 with 'POCKET' as operation.", "emit", {tool: "T2", op: "POCKET", rpm: "â€”", feed: "â€”", coolant: "Off", offset: "G54", height: "â€”", minZ: "â€”", dir: "â€”", iVal: "â€”", jVal: "â€”", _emitPrev: true}],
["N230 G0 G90 G54 X30. Y20.", "offset", "<span class='explain-tag tag-state'>State</span> G54 work offset (same as before â€” modal).", "state", {offset: "G54"}],
["N240 S10000 M3", "spindle", "<span class='explain-tag tag-state'>State</span> 10000 RPM clockwise.", "state", {rpm: "10000", dir: "CW"}],
["N250 G43 H2 Z50. T5", "offset", "<span class='explain-tag tag-state'>State</span> H2 height offset. T5 appears WITHOUT M6 â€” this is next-tool staging. Tool carousel pre-loads T5, but it's not a tool change.", "state", {height: "H2"}],
["N260 G0 Z2.", "rapid", "Rapid approach.", "ignore", null],
["N270 G1 Z-5. F150.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> Plunge to Z-5 at F150. No X/Y â€” stored as fallback only.", "heuristic", {minZ: "-5.0"}],
["N280 G1 X80. F1200.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> <strong>Lateral feed captured!</strong> X movement alone triggers the heuristic. F1200 recorded.", "heuristic", {feed: "F1200"}],
["N290 G1 Y40.", "cut", "Cutting in Y. Feed modal (1200).", "ignore", null],
["N300 G2 X30. Y20. I-25. J0.", "arc", "<span class='explain-tag tag-state'>State</span> Clockwise arc (G2)! I and J are arc center offsets â€” I=-25 (X offset to center), J=0 (Y offset). The parser tracks these for arc moves.", "state", {iVal: "I-25", jVal: "J0"}],
["N310 G1 Y20.", "cut", "Linear move (G1). Back to straight-line cutting after the arc.", "state", {iVal: "â€”", jVal: "â€”"}],
["N320 G0 Z50.", "rapid", "Retract.", "ignore", null],
["N330 M5 M9", "meta", "Spindle and coolant off.", "ignore", null],
["( FINISH PROFILE )", "comment", "<span class='explain-tag tag-state'>State</span> 'FINISH PROFILE' stored as pending op name.", "state", {pendingOp: "FINISH PROFILE"}],
["N340 T5 M6", "tool", "<span class='explain-tag tag-emit'>Emit</span> T5 tool change! Emits T2 data (POCKET, 10000 RPM, F1200, Off, Z-5.0). T5 was pre-staged at N250.", "emit", {tool: "T5", op: "FINISH PROFILE", rpm: "â€”", feed: "â€”", coolant: "Off", offset: "G54", height: "â€”", minZ: "â€”", dir: "â€”", iVal: "â€”", jVal: "â€”", _emitPrev: true}],
["N350 G0 G90 G55 X0. Y0.", "offset", "<span class='explain-tag tag-state'>State</span> G55 â€” different work offset! Parser captures the change from G54 to G55.", "state", {offset: "G55"}],
["N360 S12000 M3", "spindle", "<span class='explain-tag tag-state'>State</span> 12000 RPM â€” fastest tool in the program.", "state", {rpm: "12000", dir: "CW"}],
["N370 G43 H5 Z50. M88", "coolant", "<span class='explain-tag tag-state'>State</span> H5 height offset. M88 = Through-Spindle Coolant (TSC). Haas code â€” Mazak uses M51.", "state", {height: "H5", coolant: "TSC"}],
["N380 G0 Z2.", "rapid", "Approach.", "ignore", null],
["N390 G1 Z-10. F100.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> Deepest plunge: Z-10. F100 fallback only â€” no lateral.", "heuristic", {minZ: "-10.0"}],
["N400 G1 X60. Y30. F3000.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> <strong>Lateral feed captured!</strong> F3000 â€” fastest feed (finish pass, light cuts).", "heuristic", {feed: "F3000"}],
["N410 G3 X20. Y30. I-20. J0.", "arc", "<span class='explain-tag tag-state'>State</span> Counter-clockwise arc (G3). I=-20, J=0 define the arc center relative to the start point.", "state", {iVal: "I-20", jVal: "J0"}],
["N420 G1 X0. Y0.", "cut", "Linear finish move.", "state", {iVal: "â€”", jVal: "â€”"}],
["N430 G0 Z50.", "rapid", "Final retract.", "ignore", null],
["N440 M5 M9", "meta", "Spindle and coolant off.", "ignore", null],
["N450 M30", "end", "<span class='explain-tag tag-emit'>Emit</span> Program end. Parser emits the final tool: T5, FINISH PROFILE, 12000 RPM, F3000, TSC, Z-10.0.", "emit", {_emitFinal: true}],
["%", "meta", "Program end marker.", "ignore", null],
];

// Emitted tool records (for the table)
const TOOLS = [
  {tool:"T1", desc:"63MM FACEMILL", op:"FACING", rpm:"8000", feed:"F2500", coolant:"Flood", offset:"G54", minZ:"-0.5", emitAfterLine: 19},
  {tool:"T2", desc:"16MM ENDMILL", op:"POCKET", rpm:"10000", feed:"F1200", coolant:"Off", offset:"G54", minZ:"-5.0", emitAfterLine: 32},
  {tool:"T5", desc:"10MM BALLNOSE", op:"FINISH PROFILE", rpm:"12000", feed:"F3000", coolant:"TSC", offset:"G55", minZ:"-10.0", emitAfterLine: 44},
];

// State fields displayed in sidebar
const STATE_FIELDS = [
  ["tool", "Tool"],
  ["op", "Operation"],
  ["rpm", "RPM"],
  ["feed", "Feed"],
  ["coolant", "Coolant"],
  ["offset", "Offset"],
  ["height", "Height"],
  ["dir", "Spindle"],
  ["minZ", "Min Z"],
  ["iVal", "I Value"],
  ["jVal", "J Value"],
];

// â•â•â• EXPLORER STATE â•â•â•
let activeLine = -1;
let playing = false;
let playTimer = null;
let currentState = {};

function freshState() {
  return {tool:"â€”", op:"â€”", rpm:"â€”", feed:"â€”", coolant:"â€”", offset:"â€”", height:"â€”", dir:"â€”", minZ:"â€”", iVal:"â€”", jVal:"â€”"};
}

function renderListing() {
  const el = document.getElementById('gcodeListing');
  el.innerHTML = '';
  LINES.forEach((line, i) => {
    const div = document.createElement('div');
    div.className = `gc-line t-${line[1]}${i === activeLine ? ' active' : ''}${i < activeLine ? ' past' : ''}`;
    div.innerHTML = `<span class="gc-ln">${i+1}</span><span class="gc-code">${escHtml(line[0])}</span>`;
    div.onclick = () => selectLine(i);
    el.appendChild(div);
  });
}

function selectLine(i) {
  activeLine = i;
  // Rebuild state from start
  currentState = freshState();
  let prevState = {};
  for (let j = 0; j <= i; j++) {
    const sc = LINES[j][4];
    if (sc) {
      for (const [k, v] of Object.entries(sc)) {
        if (k.startsWith('_') || k === 'pendingOp') continue;
        currentState[k] = v;
      }
    }
  }
  // Detect what changed on THIS line
  const thisChanges = LINES[i][4];
  const changedKeys = new Set();
  if (thisChanges) {
    for (const k of Object.keys(thisChanges)) {
      if (!k.startsWith('_') && k !== 'pendingOp') changedKeys.add(k);
    }
  }

  renderListing();
  renderState(changedKeys);
  renderExplain(i);
  renderExtracted(i);

  // Scroll into view
  const lineEl = document.querySelectorAll('.gc-line')[i];
  if (lineEl) lineEl.scrollIntoView({block:'nearest', behavior:'smooth'});
}

function renderState(changedKeys) {
  const el = document.getElementById('stateCells');
  el.innerHTML = STATE_FIELDS.map(([key, label]) => {
    const val = currentState[key] || 'â€”';
    const changed = changedKeys.has(key) ? ' changed' : '';
    return `<div class="st-cell${changed}"><div class="st-val">${escHtml(val)}</div><div class="st-lbl">${label}</div></div>`;
  }).join('');
}

function renderExplain(i) {
  const el = document.getElementById('explainPanel');
  el.innerHTML = LINES[i][2];
  el.classList.add('visible');
}

function renderExtracted(lineIdx) {
  const tbody = document.getElementById('extractedBody');
  if (lineIdx < 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty">Tap a line above to begin</td></tr>';
    return;
  }
  tbody.innerHTML = '';
  let any = false;
  TOOLS.forEach((t, idx) => {
    const tr = document.createElement('tr');
    if (lineIdx >= t.emitAfterLine) {
      // Fully emitted
      tr.innerHTML = `<td>${idx+1}</td><td>${t.tool}</td><td>${t.op}</td><td>${t.rpm}</td><td>${t.feed}</td><td>${t.coolant}</td><td>${t.offset}</td><td>${t.minZ}</td>`;
      any = true;
    } else if (lineIdx >= (idx === 0 ? 8 : TOOLS[idx-1].emitAfterLine + 1)) {
      // Currently building
      tr.className = 'building';
      const s = currentState;
      tr.innerHTML = `<td>${idx+1}</td><td>${s.tool}</td><td>${s.op}</td><td>${s.rpm}</td><td>${s.feed}</td><td>${s.coolant}</td><td>${s.offset}</td><td>${s.minZ}</td>`;
      any = true;
    } else {
      tr.className = 'future';
      tr.innerHTML = `<td>${idx+1}</td><td>${t.tool}</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td>`;
      any = true;
    }
    tbody.appendChild(tr);
  });
  if (!any) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty">Parser hasn\'t reached any tool changes yet</td></tr>';
  }
}

function resetExplorer() {
  if (playing) togglePlay();
  activeLine = -1;
  currentState = freshState();
  renderListing();
  document.getElementById('stateCells').innerHTML = STATE_FIELDS.map(([key, label]) =>
    `<div class="st-cell"><div class="st-val">â€”</div><div class="st-lbl">${label}</div></div>`
  ).join('');
  document.getElementById('explainPanel').classList.remove('visible');
  document.getElementById('extractedBody').innerHTML = '<tr><td colspan="8" class="empty">Tap a line above to begin</td></tr>';
}

function stepNext() {
  if (playing) togglePlay();
  if (activeLine < LINES.length - 1) selectLine(activeLine + 1);
  else if (activeLine < 0) selectLine(0);
}

function stepPrev() {
  if (playing) togglePlay();
  if (activeLine > 0) selectLine(activeLine - 1);
  else if (activeLine < 0) selectLine(0);
}

function togglePlay() {
  playing = !playing;
  const btn = document.getElementById('playBtn');
  if (playing) {
    btn.innerHTML = 'â¸ Pause';
    btn.classList.add('active');
    if (activeLine < 0) activeLine = -1;
    playTimer = setInterval(() => {
      if (activeLine >= LINES.length - 1) { togglePlay(); return; }
      selectLine(activeLine + 1);
    }, 1100);
  } else {
    btn.innerHTML = 'â–¶ Auto';
    btn.classList.remove('active');
    clearInterval(playTimer);
  }
}

function escHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

// â•â•â• SCROLL REVEAL â•â•â•
const revealObserver = new IntersectionObserver((entries) => {
  entries.forEach(e => {
    if (e.isIntersecting) {
      e.target.classList.add('visible');
    }
  });
}, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));

// â•â•â• PROGRESS BAR â•â•â•
function updateProgress() {
  const h = document.documentElement.scrollHeight - window.innerHeight;
  const p = h > 0 ? (window.scrollY / h) * 100 : 0;
  document.getElementById('progressBar').style.width = p + '%';
}
window.addEventListener('scroll', updateProgress, {passive: true});

// â•â•â• NAV DOTS â•â•â•
const chapters = document.querySelectorAll('.chapter');
const dots = document.querySelectorAll('.nav-dot');

function scrollToChapter(i) {
  chapters[i].scrollIntoView({behavior:'smooth'});
}

const chapterObserver = new IntersectionObserver((entries) => {
  entries.forEach(e => {
    if (e.isIntersecting) {
      const idx = Array.from(chapters).indexOf(e.target);
      dots.forEach((d, i) => d.classList.toggle('active', i === idx));
    }
  });
}, { threshold: 0.3 });

chapters.forEach(ch => chapterObserver.observe(ch));

// â•â•â• INIT â•â•â•
renderListing();
resetExplorer();
</script>

<!-- Three.js for 3D datum viewer -->
<script type="importmap">
{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/" } }
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

const canvas = document.getElementById('viewer3d');
if (canvas) {
  const container = document.getElementById('viewerContainer');
  const w = canvas.clientWidth || 800;
  const h = canvas.clientHeight || 420;

  // Scene
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0c12);
  scene.fog = new THREE.Fog(0x0a0c12, 400, 800);

  // Camera
  const camera = new THREE.PerspectiveCamera(35, w / h, 0.1, 1000);
  camera.position.set(180, 140, 200);

  // Renderer
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setSize(w, h);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;

  // Controls
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;
  controls.target.set(40, 10, 20);
  controls.minDistance = 80;
  controls.maxDistance = 500;
  controls.update();

  // Lights
  const ambient = new THREE.AmbientLight(0x404060, 1.2);
  scene.add(ambient);
  const dirLight = new THREE.DirectionalLight(0xffffff, 1.8);
  dirLight.position.set(100, 150, 80);
  dirLight.castShadow = true;
  dirLight.shadow.mapSize.set(1024, 1024);
  dirLight.shadow.camera.near = 10;
  dirLight.shadow.camera.far = 400;
  dirLight.shadow.camera.left = -150;
  dirLight.shadow.camera.right = 150;
  dirLight.shadow.camera.top = 150;
  dirLight.shadow.camera.bottom = -150;
  scene.add(dirLight);
  const fillLight = new THREE.DirectionalLight(0x6c8aff, 0.3);
  fillLight.position.set(-80, 40, -60);
  scene.add(fillLight);

  // Ground grid
  const gridHelper = new THREE.GridHelper(300, 30, 0x1e2133, 0x13151e);
  gridHelper.position.y = -30;
  scene.add(gridHelper);

  // â”€â”€â”€ VISE (base + fixed jaw + movable jaw) â”€â”€â”€
  const viseMat = new THREE.MeshStandardMaterial({ color: 0x3a3d4a, roughness: 0.7, metalness: 0.4 });
  // Base
  const viseBase = new THREE.Mesh(new THREE.BoxGeometry(120, 18, 70), viseMat);
  viseBase.position.set(40, -21, 20);
  viseBase.castShadow = true; viseBase.receiveShadow = true;
  scene.add(viseBase);
  // Fixed jaw
  const fixedJaw = new THREE.Mesh(new THREE.BoxGeometry(120, 30, 8), viseMat);
  fixedJaw.position.set(40, -6, -11);
  fixedJaw.castShadow = true;
  scene.add(fixedJaw);
  // Movable jaw
  const moveJaw = new THREE.Mesh(new THREE.BoxGeometry(120, 30, 8), viseMat);
  moveJaw.position.set(40, -6, 51);
  moveJaw.castShadow = true;
  scene.add(moveJaw);

  // â”€â”€â”€ STOCK BLOCK â”€â”€â”€
  const stockMat = new THREE.MeshStandardMaterial({ color: 0x6c8aff, roughness: 0.35, metalness: 0.5, transparent: true, opacity: 0.7 });
  const stock = new THREE.Mesh(new THREE.BoxGeometry(100, 30, 40), stockMat);
  stock.position.set(40, 6, 20);
  stock.castShadow = true; stock.receiveShadow = true;
  scene.add(stock);

  // Stock wireframe
  const stockWire = new THREE.LineSegments(
    new THREE.EdgesGeometry(new THREE.BoxGeometry(100, 30, 40)),
    new THREE.LineBasicMaterial({ color: 0x8ca8ff, transparent: true, opacity: 0.5 })
  );
  stockWire.position.copy(stock.position);
  scene.add(stockWire);

  // â”€â”€â”€ DATUM ARROW HELPER â”€â”€â”€
  function makeDatum(label, color, position) {
    const group = new THREE.Group();
    group.position.copy(position);

    const len = 25;
    const colors = [0xff5c5c, 0x5cff5c, 0x5c8aff]; // X, Y, Z
    const dirs = [new THREE.Vector3(1,0,0), new THREE.Vector3(0,1,0), new THREE.Vector3(0,0,1)];
    dirs.forEach((dir, i) => {
      const arrow = new THREE.ArrowHelper(dir, new THREE.Vector3(0,0,0), len, colors[i], 5, 3);
      group.add(arrow);
    });

    // Origin sphere
    const sphere = new THREE.Mesh(
      new THREE.SphereGeometry(2.5, 16, 16),
      new THREE.MeshStandardMaterial({ color, emissive: color, emissiveIntensity: 0.5 })
    );
    group.add(sphere);

    // Label sprite
    const cvs = document.createElement('canvas');
    cvs.width = 128; cvs.height = 48;
    const ctx = cvs.getContext('2d');
    ctx.fillStyle = '#' + color.toString(16).padStart(6, '0');
    ctx.font = 'bold 32px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(label, 64, 34);
    const tex = new THREE.CanvasTexture(cvs);
    const spriteMat = new THREE.SpriteMaterial({ map: tex, transparent: true });
    const sprite = new THREE.Sprite(spriteMat);
    sprite.scale.set(24, 9, 1);
    sprite.position.set(0, 30, 0);
    group.add(sprite);

    scene.add(group);
    return group;
  }

  // G54 â€” top-left corner of stock (common datum placement)
  const g54 = makeDatum('G54', 0xffcb5c, new THREE.Vector3(-10, 21, 0));

  // G55 â€” opposite corner (for second op / flip)
  const g55 = makeDatum('G55', 0xcb6cff, new THREE.Vector3(90, 21, 40));

  // â”€â”€â”€ CAMERA VIEWS â”€â”€â”€
  window.setView = function(view) {
    document.querySelectorAll('.viewer-btn').forEach(b => b.classList.remove('active-view'));
    document.querySelector(`.viewer-btn[data-view="${view}"]`)?.classList.add('active-view');

    let pos, target = new THREE.Vector3(40, 10, 20);
    switch(view) {
      case 'top':   pos = new THREE.Vector3(40, 250, 20); break;
      case 'front': pos = new THREE.Vector3(40, 30, 200); break;
      case 'right': pos = new THREE.Vector3(250, 30, 20); break;
      default:      pos = new THREE.Vector3(180, 140, 200); break;
    }
    // Animate
    const start = camera.position.clone();
    const startTarget = controls.target.clone();
    let t = 0;
    function animStep() {
      t += 0.04;
      if (t > 1) t = 1;
      const ease = 1 - Math.pow(1 - t, 3); // ease out cubic
      camera.position.lerpVectors(start, pos, ease);
      controls.target.lerpVectors(startTarget, target, ease);
      controls.update();
      if (t < 1) requestAnimationFrame(animStep);
    }
    animStep();
  };

  // â”€â”€â”€ ANIMATE â”€â”€â”€
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // â”€â”€â”€ RESIZE â”€â”€â”€
  const ro = new ResizeObserver(() => {
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h, false);
  });
  ro.observe(canvas);
}
</script>
</body>
</html>
