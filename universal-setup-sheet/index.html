<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Universal Setup Sheet ‚Äî How It Works</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TEMPLATE: makingsoftware-style explainer
   Reusable structure ‚Äî swap content per project
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #08090c;
  --bg-raised: #0e1017;
  --bg-surface: #13151e;
  --bg-interactive: #181b27;
  --text: #e8eaf0;
  --text-secondary: #8b90a0;
  --text-dim: #4a4e5e;
  --border: #1e2133;
  --border-subtle: #151827;
  --accent: #6c8aff;
  --accent-glow: rgba(108, 138, 255, 0.15);
  --accent2: #ff7b5c;
  --accent3: #5cffa0;
  --accent4: #ffcb5c;
  --accent5: #cb6cff;
  --column: 680px;
  --wide: 900px;
  --gutter: 24px;
  --font: 'Inter', -apple-system, system-ui, sans-serif;
  --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
}

/* ‚ïê‚ïê‚ïê PROGRESS BAR ‚ïê‚ïê‚ïê */
.progress-bar {
  position: fixed; top: 0; left: 0; z-index: 1000;
  height: 2px; background: var(--accent);
  width: 0%; transition: width 0.1s linear;
  box-shadow: 0 0 8px var(--accent);
}

/* ‚ïê‚ïê‚ïê NAV DOTS ‚ïê‚ïê‚ïê */
.nav-dots {
  position: fixed; right: 16px; top: 50%; transform: translateY(-50%);
  z-index: 100; display: flex; flex-direction: column; gap: 12px;
}
.nav-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--text-dim); cursor: pointer;
  transition: all 0.3s ease; border: none; padding: 0;
  position: relative;
}
.nav-dot::after {
  content: attr(data-label);
  position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
  background: var(--bg-surface); color: var(--text-secondary);
  padding: 4px 10px; border-radius: 6px; font-size: 0.7em;
  white-space: nowrap; opacity: 0; pointer-events: none;
  transition: opacity 0.2s; border: 1px solid var(--border);
}
.nav-dot:hover::after { opacity: 1; }
.nav-dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); transform: scale(1.3); }

@media (max-width: 768px) { .nav-dots { display: none; } }

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.col { max-width: var(--column); margin: 0 auto; padding: 0 var(--gutter); }
.col-wide { max-width: var(--wide); margin: 0 auto; padding: 0 var(--gutter); }

/* ‚ïê‚ïê‚ïê REVEAL ANIMATION ‚ïê‚ïê‚ïê */
.reveal {
  opacity: 0; transform: translateY(30px);
  transition: opacity 0.7s cubic-bezier(0.16, 1, 0.3, 1),
              transform 0.7s cubic-bezier(0.16, 1, 0.3, 1);
}
.reveal.visible { opacity: 1; transform: translateY(0); }
.reveal.delay-1 { transition-delay: 0.1s; }
.reveal.delay-2 { transition-delay: 0.2s; }
.reveal.delay-3 { transition-delay: 0.3s; }
.reveal.delay-4 { transition-delay: 0.4s; }

/* ‚ïê‚ïê‚ïê CHAPTER SYSTEM ‚ïê‚ïê‚ïê */
.chapter {
  padding: 100px 0;
  min-height: 60vh;
  position: relative;
}
.chapter + .chapter { border-top: 1px solid var(--border-subtle); }

.chapter-label {
  font-size: 0.65em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 3px;
  color: var(--accent); margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.chapter-label::before {
  content: ''; width: 20px; height: 1px; background: var(--accent);
}

.chapter h2 {
  font-size: clamp(1.8em, 5vw, 2.8em);
  font-weight: 800; letter-spacing: -0.03em;
  line-height: 1.15; margin-bottom: 20px;
  background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

.chapter .lead {
  font-size: 1.1em; color: var(--text-secondary);
  line-height: 1.7; max-width: 540px;
}

/* ‚ïê‚ïê‚ïê HERO ‚ïê‚ïê‚ïê */
.hero {
  min-height: 100vh; display: flex; flex-direction: column;
  justify-content: center; align-items: flex-start;
  text-align: left; position: relative;
  padding: 60px var(--gutter);
  overflow: hidden;
}

.hero-bg {
  position: absolute; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 60% 40% at 50% 40%, rgba(108, 138, 255, 0.08) 0%, transparent 70%),
    radial-gradient(ellipse 40% 30% at 30% 70%, rgba(255, 123, 92, 0.04) 0%, transparent 60%);
}

.hero-grid {
  position: absolute; inset: 0; z-index: 0;
  background-image:
    linear-gradient(var(--border-subtle) 1px, transparent 1px),
    linear-gradient(90deg, var(--border-subtle) 1px, transparent 1px);
  background-size: 60px 60px;
  mask-image: radial-gradient(ellipse 70% 50% at 50% 50%, black 20%, transparent 70%);
  -webkit-mask-image: radial-gradient(ellipse 70% 50% at 50% 50%, black 20%, transparent 70%);
  opacity: 0.5;
}

.hero-content { position: relative; z-index: 1; max-width: 700px; padding-left: var(--gutter); }

.hero-badge {
  display: inline-flex; align-items: center; gap: 8px;
  background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: 100px; padding: 6px 16px 6px 8px;
  font-size: 0.78em; color: var(--text-secondary);
  margin-bottom: 32px;
}
.hero-badge-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--accent3); box-shadow: 0 0 6px var(--accent3);
  animation: pulse-dot 2s ease infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 1; } 50% { opacity: 0.4; }
}

.hero h1 {
  font-size: clamp(2.2em, 7vw, 4em);
  font-weight: 900; letter-spacing: -0.04em;
  line-height: 1.05; margin-bottom: 24px;
}
.hero h1 .highlight {
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent5) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero-sub {
  font-size: 1.15em; color: var(--text-secondary);
  line-height: 1.6; max-width: 520px; margin: 0 0 40px;
}

.hero-stats {
  display: flex; gap: 32px; justify-content: flex-start; flex-wrap: wrap;
}
.hero-stat {
  text-align: center;
}
.hero-stat-val {
  font-size: 1.8em; font-weight: 800; color: var(--text);
  font-family: var(--mono);
}
.hero-stat-label {
  font-size: 0.72em; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 1px;
}

.scroll-hint {
  position: absolute; bottom: 32px; left: 50%; transform: translateX(-50%);
  color: var(--text-dim); font-size: 0.72em; text-align: center;
  animation: float 2s ease-in-out infinite;
}
.scroll-hint svg { display: block; margin: 6px auto 0; }
@keyframes float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(6px); } }

/* ‚ïê‚ïê‚ïê PROBLEM/SOLUTION ‚ïê‚ïê‚ïê */
.comparison {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 16px; margin-top: 40px;
}
@media (max-width: 640px) { .comparison { grid-template-columns: 1fr; } }

.compare-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 16px; padding: 28px;
  position: relative; overflow: hidden;
}
.compare-card.bad { border-color: rgba(255, 100, 80, 0.2); }
.compare-card.good { border-color: rgba(92, 255, 160, 0.2); }

.compare-card .badge {
  font-size: 0.65em; font-weight: 700; text-transform: uppercase;
  letter-spacing: 2px; margin-bottom: 12px;
}
.compare-card.bad .badge { color: var(--accent2); }
.compare-card.good .badge { color: var(--accent3); }

.compare-card h3 {
  font-size: 1.3em; font-weight: 700; margin-bottom: 8px;
}
.compare-card p { color: var(--text-secondary); font-size: 0.92em; }

.compare-card .time {
  font-family: var(--mono); font-size: 2em; font-weight: 800;
  margin-top: 16px;
}
.compare-card.bad .time { color: var(--accent2); }
.compare-card.good .time { color: var(--accent3); }

/* ‚ïê‚ïê‚ïê PIPELINE ‚ïê‚ïê‚ïê */
.pipeline {
  display: flex; align-items: stretch; gap: 0;
  margin: 48px 0; overflow-x: auto;
  padding-bottom: 8px;
}
.pipe-stage {
  flex: 1; min-width: 160px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  padding: 24px 20px;
  text-align: center;
  position: relative;
  transition: all 0.3s ease;
  cursor: default;
}
.pipe-stage:first-child { border-radius: 14px 0 0 14px; }
.pipe-stage:last-child { border-radius: 0 14px 14px 0; }

.pipe-stage:hover {
  background: var(--bg-interactive);
  border-color: var(--accent);
  z-index: 1;
}

.pipe-stage .icon {
  font-size: 1.8em; margin-bottom: 8px;
  display: block;
}
.pipe-stage h4 {
  font-size: 0.85em; font-weight: 700; margin-bottom: 4px;
}
.pipe-stage p {
  font-size: 0.72em; color: var(--text-dim); line-height: 1.4;
}

.pipe-arrow {
  display: flex; align-items: center;
  color: var(--text-dim); font-size: 1.2em;
  flex-shrink: 0; padding: 0 2px;
}

/* ‚ïê‚ïê‚ïê INTERACTIVE G-CODE EXPLORER ‚ïê‚ïê‚ïê */
.explorer-container {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin: 48px 0;
}

.explorer-toolbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 20px;
  background: var(--bg-interactive);
  border-bottom: 1px solid var(--border);
}
.explorer-toolbar-title {
  font-size: 0.78em; font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: 1px;
}
.explorer-controls { display: flex; gap: 6px; }

.ex-btn {
  width: 32px; height: 32px; border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg-surface);
  color: var(--text-secondary);
  cursor: pointer; font-size: 0.85em;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.ex-btn:hover { border-color: var(--accent); color: var(--accent); }
.ex-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

.ex-btn-wide {
  width: auto; padding: 0 14px;
  font-size: 0.75em; font-weight: 600;
  gap: 4px;
}

.explorer-body {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0;
}

@media (min-width: 768px) {
  .explorer-body {
    grid-template-columns: 1fr 300px;
  }
}

/* G-code listing */
.gcode-listing {
  max-height: 460px;
  overflow-y: hidden;
  font-family: var(--mono);
  font-size: 0.82em;
  line-height: 1.8;
  touch-action: pan-y;
}

.gc-line {
  display: flex; padding: 1px 20px;
  cursor: pointer; border-left: 3px solid transparent;
  transition: all 0.12s ease;
}
.gc-line:hover { background: var(--bg-interactive); }
.gc-line.active {
  background: rgba(108, 138, 255, 0.08);
  border-left-color: var(--accent);
}
.gc-line.past { opacity: 0.35; }

.gc-ln {
  color: var(--text-dim); min-width: 30px;
  text-align: right; margin-right: 16px;
  user-select: none; font-size: 0.85em;
}
.gc-code { white-space: pre; }

/* Syntax colors */
.gc-line.t-meta .gc-code { color: var(--text-dim); }
.gc-line.t-header .gc-code { color: var(--accent5); }
.gc-line.t-comment .gc-code { color: #a78bfa; }
.gc-line.t-tool .gc-code { color: var(--accent); font-weight: 600; }
.gc-line.t-spindle .gc-code { color: var(--accent4); }
.gc-line.t-coolant .gc-code { color: #22d3ee; }
.gc-line.t-offset .gc-code { color: #f472b6; }
.gc-line.t-feed .gc-code { color: var(--accent3); }
.gc-line.t-rapid .gc-code { color: var(--text-dim); }
.gc-line.t-cut .gc-code { color: var(--text); }
.gc-line.t-arc .gc-code { color: #fb923c; }
.gc-line.t-end .gc-code { color: var(--text-dim); font-weight: 600; }

/* State sidebar */
.state-sidebar {
  border-top: 1px solid var(--border);
  padding: 0;
  display: flex; flex-direction: column;
}

@media (min-width: 768px) {
  .state-sidebar {
    border-top: none;
    border-left: 1px solid var(--border);
  }
}

.state-sidebar-header {
  font-size: 0.68em; font-weight: 600;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--text-dim); padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}

.state-cells { display: grid; grid-template-columns: 1fr 1fr; gap: 0; flex: 1; }

.st-cell {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border-subtle);
  border-right: 1px solid var(--border-subtle);
  transition: background 0.2s;
}
.st-cell:nth-child(2n) { border-right: none; }

.st-cell .st-val {
  font-family: var(--mono); font-weight: 600;
  font-size: 0.95em; color: var(--text);
  transition: color 0.2s;
}
.st-cell .st-lbl {
  font-size: 0.62em; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.5px;
  margin-top: 2px;
}
.st-cell.changed {
  background: rgba(108, 138, 255, 0.06);
}
.st-cell.changed .st-val { color: var(--accent); }

/* Explain panel */
.explain-panel {
  border-top: 1px solid var(--border);
  padding: 16px 20px;
  font-size: 0.88em;
  line-height: 1.6;
  color: var(--text-secondary);
  min-height: 72px;
  display: none;
}
.explain-panel.visible { display: block; }

.explain-tag {
  display: inline-block;
  padding: 2px 10px; border-radius: 5px;
  font-size: 0.75em; font-weight: 700;
  margin-right: 6px; vertical-align: middle;
}
.tag-phase1 { background: rgba(203, 108, 255, 0.15); color: var(--accent5); }
.tag-state { background: rgba(108, 138, 255, 0.15); color: var(--accent); }
.tag-emit { background: rgba(255, 203, 92, 0.15); color: var(--accent4); }
.tag-heuristic { background: rgba(92, 255, 160, 0.15); color: var(--accent3); }
.tag-ignore { background: rgba(74, 78, 94, 0.2); color: var(--text-dim); }

/* ‚ïê‚ïê‚ïê EXTRACTED TABLE ‚ïê‚ïê‚ïê */
.data-table-wrap {
  margin: 32px 0;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
}
.data-table-header {
  padding: 12px 20px;
  font-size: 0.68em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--text-dim);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
}
.data-table-header::before {
  content: ''; width: 3px; height: 12px;
  background: var(--accent4); border-radius: 2px;
}

.data-table { width: 100%; border-collapse: collapse; }
.data-table th {
  padding: 10px 14px; text-align: left;
  font-size: 0.7em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px;
  color: var(--text-dim);
  background: var(--bg-interactive);
  border-bottom: 1px solid var(--border);
}
.data-table td {
  padding: 10px 14px;
  font-family: var(--mono); font-size: 0.82em;
  border-bottom: 1px solid var(--border-subtle);
  color: var(--text);
}
.data-table tr:last-child td { border-bottom: none; }
.data-table tr.building td { color: var(--accent); }
.data-table tr.future td { opacity: 0.15; }
.data-table .empty { color: var(--text-dim); font-family: var(--font); text-align: center; padding: 24px; }

/* ‚ïê‚ïê‚ïê TERM DEFINITIONS ‚ïê‚ïê‚ïê */
.term {
  color: var(--accent);
  border-bottom: 1px dashed rgba(108, 138, 255, 0.4);
  cursor: help; position: relative;
}
.term:hover .term-tip {
  opacity: 1; transform: translateY(0); pointer-events: auto;
}
.term-tip {
  position: absolute; bottom: calc(100% + 8px); left: 50%;
  transform: translateX(-50%) translateY(4px);
  background: var(--bg-interactive);
  border: 1px solid var(--border);
  border-radius: 10px; padding: 10px 14px;
  font-size: 0.82em; color: var(--text-secondary);
  white-space: normal; width: 260px;
  opacity: 0; pointer-events: none;
  transition: all 0.2s ease;
  z-index: 50; line-height: 1.5;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}

/* ‚ïê‚ïê‚ïê CONCEPT CARDS ‚ïê‚ïê‚ïê */
.concept-grid {
  display: grid; grid-template-columns: 1fr;
  gap: 16px; margin: 40px 0;
}
@media (min-width: 640px) {
  .concept-grid.cols-2 { grid-template-columns: 1fr 1fr; }
  .concept-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
}

.concept-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 14px; padding: 24px;
  transition: border-color 0.3s;
}
.concept-card:hover { border-color: var(--accent); }
.concept-card .cc-icon { font-size: 1.5em; margin-bottom: 10px; }
.concept-card h4 { font-size: 0.95em; font-weight: 700; margin-bottom: 6px; }
.concept-card p { font-size: 0.82em; color: var(--text-secondary); line-height: 1.5; }

/* ‚ïê‚ïê‚ïê TOOL LIBRARY MATCHER ‚ïê‚ïê‚ïê */
.lib-matcher {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 16px; overflow: hidden;
  margin: 40px 0;
}
.lib-matcher-header {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
  font-size: 0.68em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--text-dim);
}
.lib-matcher-header::before {
  content: ''; width: 3px; height: 12px;
  background: var(--accent4); border-radius: 2px;
}
.lib-matcher-body { padding: 24px; }
.lib-matcher-row {
  display: grid; grid-template-columns: 1fr auto 1fr;
  gap: 20px; align-items: start;
}
@media (max-width: 640px) {
  .lib-matcher-row { grid-template-columns: 1fr; }
  .lib-matcher-arrow { transform: rotate(90deg); }
}
.lib-gcode-box {
  background: var(--bg-interactive);
  border: 1px solid var(--border);
  border-radius: 10px; padding: 14px;
  font-family: var(--mono); font-size: 0.78em;
  line-height: 1.8;
}
.lib-gcode-box .lib-clue {
  background: rgba(255, 203, 92, 0.12);
  border: 1px solid rgba(255, 203, 92, 0.3);
  border-radius: 4px; padding: 0 4px;
  color: var(--accent4); font-weight: 600;
  transition: all 0.4s;
}
.lib-gcode-box .lib-clue.active {
  background: rgba(255, 203, 92, 0.25);
  box-shadow: 0 0 8px rgba(255, 203, 92, 0.2);
}
.lib-matcher-arrow {
  font-size: 1.4em; color: var(--text-dim);
  align-self: center; text-align: center;
  padding-top: 20px;
}
.lib-matcher-arrow.matched { color: var(--accent3); }
.lib-cards { display: flex; flex-direction: column; gap: 8px; }
.lib-card {
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg-interactive);
  transition: all 0.4s;
  font-size: 0.82em;
}
.lib-card-name { font-weight: 700; margin-bottom: 2px; }
.lib-card-detail { font-size: 0.85em; color: var(--text-secondary); }
.lib-card.matched {
  border-color: var(--accent3);
  background: rgba(92, 255, 160, 0.06);
  box-shadow: 0 0 12px rgba(92, 255, 160, 0.1);
}
.lib-card.dimmed { opacity: 0.35; }
.lib-match-tag {
  display: inline-block; font-size: 0.7em; font-weight: 700;
  color: var(--accent3); margin-left: 8px;
  text-transform: uppercase; letter-spacing: 1px;
}
.lib-matcher-explain {
  margin-top: 16px; padding: 14px;
  background: rgba(108, 138, 255, 0.05);
  border-radius: 10px;
  font-size: 0.85em; color: var(--text-secondary);
  line-height: 1.6;
  min-height: 44px;
}
.lib-matcher-explain strong { color: var(--text); }
.lib-matcher-controls {
  display: flex; gap: 8px; margin-top: 16px;
}

/* ‚ïê‚ïê‚ïê CALLOUT ‚ïê‚ïê‚ïê */
.callout {
  margin: 32px 0; padding: 20px 24px;
  border-left: 3px solid var(--accent);
  background: rgba(108, 138, 255, 0.04);
  border-radius: 0 12px 12px 0;
  font-size: 0.92em; color: var(--text-secondary);
}
.callout strong { color: var(--text); }

/* ‚ïê‚ïê‚ïê CODE INLINE ‚ïê‚ïê‚ïê */
code {
  font-family: var(--mono); font-size: 0.88em;
  background: var(--bg-interactive);
  padding: 2px 7px; border-radius: 5px;
  color: var(--accent);
}

/* ‚ïê‚ïê‚ïê SHEET PREVIEW ‚ïê‚ïê‚ïê */
.theme-switcher {
  display: flex; gap: 8px; margin: 24px 0 20px; flex-wrap: wrap;
}
.theme-btn {
  padding: 6px 18px; border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg-surface);
  color: var(--text-secondary);
  cursor: pointer; font-size: 0.78em; font-weight: 600;
  font-family: var(--font);
  transition: all 0.2s;
}
.theme-btn:hover { border-color: var(--accent); color: var(--accent); }
.theme-btn.active-theme { background: var(--accent); color: white; border-color: var(--accent); }

.sheet-preview {
  border-radius: 10px; overflow: hidden;
  box-shadow: 0 8px 40px rgba(0,0,0,0.5);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  transition: all 0.4s ease;
  /* Default: workshop theme */
  --sp-bg: #f4f2ed;
  --sp-text: #0a0f1a;
  --sp-muted: #7f8c8d;
  --sp-header: #1a1f2e;
  --sp-border: #d5d0c8;
  --sp-row-alt: #eceae4;
  --sp-accent: #c0392b;
  --sp-section-bg: #e8e5dd;
  --sp-footer: #1a1f2e;
}
.sheet-preview.blueprint {
  --sp-bg: #0c1929;
  --sp-text: #c8ddf0;
  --sp-muted: #5a7a96;
  --sp-header: #071220;
  --sp-border: #1a3352;
  --sp-row-alt: #0f1f35;
  --sp-accent: #4a9eff;
  --sp-section-bg: #0f1f35;
  --sp-footer: #071220;
}
.sheet-preview.midnight {
  --sp-bg: #13151e;
  --sp-text: #e8eaf0;
  --sp-muted: #4a4e5e;
  --sp-header: #08090c;
  --sp-border: #1e2133;
  --sp-row-alt: #181b27;
  --sp-accent: #ff7b5c;
  --sp-section-bg: #181b27;
  --sp-footer: #08090c;
}
.sheet-preview.clean {
  --sp-bg: #ffffff;
  --sp-text: #111827;
  --sp-muted: #9ca3af;
  --sp-header: #111827;
  --sp-border: #e5e7eb;
  --sp-row-alt: #f9fafb;
  --sp-accent: #2563eb;
  --sp-section-bg: #f3f4f6;
  --sp-footer: #111827;
}

.sp-header {
  background: var(--sp-header);
  color: white;
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  padding: 0;
}
.sp-header-left { padding: 14px 20px; }
.sp-header-center {
  padding: 12px 24px; text-align: center;
  border-left: 1px solid rgba(255,255,255,0.1);
  border-right: 1px solid rgba(255,255,255,0.1);
}
.sp-header-right { padding: 14px 20px; text-align: right; }
.sp-label {
  font-size: 0.7em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 3px;
  color: rgba(255,255,255,0.4);
}
.sp-part {
  font-family: var(--mono); font-size: 1.6em;
  font-weight: 800; letter-spacing: 1px;
}
.sp-machine-label {
  font-size: 0.65em; font-weight: 600;
  text-transform: uppercase; letter-spacing: 1px;
  color: rgba(255,255,255,0.35); margin-bottom: 2px;
}
.sp-machine { font-size: 0.95em; font-weight: 600; }
.sp-rev {
  display: inline-block;
  background: var(--sp-accent); color: white;
  font-family: var(--mono); font-weight: 700;
  font-size: 1.1em; padding: 4px 14px;
  border-radius: 4px; letter-spacing: 2px;
}
.sp-date {
  font-family: var(--mono); font-size: 0.72em;
  color: rgba(255,255,255,0.4); margin-top: 4px;
}

.sp-info-row {
  display: grid; grid-template-columns: repeat(4, 1fr);
  background: var(--sp-bg);
  border-bottom: 2px solid var(--sp-border);
}
.sp-info {
  padding: 10px 16px;
  border-right: 1px solid var(--sp-border);
}
.sp-info:last-child { border-right: none; }
.sp-info-label {
  font-size: 0.6em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--sp-muted); margin-bottom: 2px;
}
.sp-info-val {
  font-size: 0.85em; font-weight: 600;
  color: var(--sp-text);
}

.sp-section-head {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 16px;
  background: var(--sp-section-bg);
  border-bottom: 1px solid var(--sp-border);
  border-top: 1px solid var(--sp-border);
  font-size: 0.68em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 2px;
  color: var(--sp-text);
}
.sp-section-num {
  font-family: var(--mono); font-size: 0.9em; font-weight: 700;
  color: white; background: var(--sp-muted);
  width: 20px; height: 20px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 3px;
}

.sp-table {
  width: 100%; border-collapse: collapse;
  background: var(--sp-bg);
}
.sp-table th {
  padding: 7px 12px; text-align: left;
  font-size: 0.6em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--sp-muted);
  border-bottom: 2px solid var(--sp-border);
  background: var(--sp-bg);
}
.sp-table td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--sp-border);
  color: var(--sp-text);
}
.sp-table tr:nth-child(even) td { background: var(--sp-row-alt); }
.sp-table tbody tr { cursor: pointer; transition: all 0.2s; }
.sp-table tbody tr:hover td { background: rgba(108, 138, 255, 0.08); }
.sp-table tbody tr.sp-active td { background: rgba(108, 138, 255, 0.12); border-bottom-color: transparent; }
.sp-gcode-row td { padding: 0 !important; border-bottom: 1px solid var(--sp-border); cursor: default; }
.sp-gcode-row:hover td { background: transparent !important; }
.sp-gcode-expand {
  max-height: 0; overflow: hidden;
  transition: max-height 0.3s ease, padding 0.3s ease;
  font-family: var(--mono); font-size: 0.72em;
  line-height: 1.7; color: var(--sp-muted);
  background: var(--sp-section-bg);
  padding: 0 14px;
}
.sp-gcode-expand.open { max-height: 200px; padding: 10px 14px; }
.sp-gcode-expand .sp-gcode-highlight { color: var(--sp-accent); font-weight: 600; }
.sp-mono { font-family: var(--mono); font-weight: 600; font-size: 0.92em; }
.sp-bold { font-weight: 700; }
.sp-op {
  font-family: var(--mono); font-weight: 600;
  font-size: 0.78em; text-transform: uppercase;
  letter-spacing: 0.5px; color: var(--sp-accent);
}
.sp-depth { color: var(--sp-accent); }
.sp-chevron {
  color: var(--sp-muted); font-size: 0.8em;
  text-align: center; width: 20px;
  transition: transform 0.3s;
}
.sp-active .sp-chevron { transform: rotate(180deg); color: var(--sp-accent); }
.sp-tap-hint {
  margin-left: auto;
  font-size: 0.6em; font-weight: 500;
  text-transform: none; letter-spacing: 0.5px;
  color: var(--sp-muted);
  animation: hintPulse 2s ease infinite;
}
@keyframes hintPulse {
  0%, 100% { opacity: 0.6; } 50% { opacity: 1; }
}

.sp-coolant {
  font-size: 0.68em; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px;
  padding: 2px 8px; border-radius: 3px;
  display: inline-block;
}
.sp-coolant.flood { background: rgba(41,128,185,0.12); color: #2980b9; }
.sp-coolant.tsc { background: rgba(39,174,96,0.12); color: #27ae60; }
.sp-coolant.mist { background: rgba(212,160,23,0.12); color: #d4a017; }

.sp-images {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 0; padding: 0;
  background: var(--sp-bg);
}
.sp-fixture-img {
  aspect-ratio: 16/10;
  border-right: 1px solid var(--sp-border);
  display: flex; align-items: center; justify-content: center;
  padding: 8px;
  background: var(--sp-bg);
}
.sp-3d-container {
  aspect-ratio: 16/10;
  position: relative;
  background: var(--sp-bg);
}
#miniViewer3d {
  width: 100%; height: 100%;
  display: block; cursor: grab;
}
#miniViewer3d:active { cursor: grabbing; }
.sp-3d-label {
  position: absolute; bottom: 6px; right: 8px;
  font-size: 0.55em; font-weight: 600;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--sp-muted);
  opacity: 0.5;
  pointer-events: none;
}

.sp-footer {
  display: flex; justify-content: space-between;
  padding: 8px 16px;
  background: var(--sp-footer);
  color: rgba(255,255,255,0.35);
  font-family: var(--mono); font-size: 0.62em;
  letter-spacing: 0.5px;
}

@media (max-width: 640px) {
  .sp-header { grid-template-columns: 1fr; text-align: center; }
  .sp-header-left, .sp-header-right { padding: 8px 16px; text-align: center; }
  .sp-header-center { border-left: none; border-right: none; border-top: 1px solid rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.1); }
  .sp-info-row { grid-template-columns: 1fr 1fr; }
  .sp-images { grid-template-columns: 1fr; }
  .sp-table { font-size: 0.78em; }
}

/* ‚ïê‚ïê‚ïê 3D VIEWER ‚ïê‚ïê‚ïê */
.viewer-container {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin: 40px 0;
}
.viewer-toolbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 20px;
  background: var(--bg-interactive);
  border-bottom: 1px solid var(--border);
}
.viewer-toolbar-title {
  font-size: 0.78em; font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: 1px;
}
.viewer-controls { display: flex; gap: 6px; }
.viewer-btn.active-view { background: var(--accent); color: white; border-color: var(--accent); }

#viewer3d {
  width: 100%; height: 420px;
  display: block; cursor: grab;
  background: #0a0c12;
}
#viewer3d:active { cursor: grabbing; }

.viewer-legend {
  display: flex; gap: 16px; flex-wrap: wrap;
  padding: 10px 20px;
  border-top: 1px solid var(--border);
  font-size: 0.72em; color: var(--text-secondary);
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-swatch {
  width: 10px; height: 10px; border-radius: 3px;
  display: inline-block;
}

/* ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê */
.footer {
  text-align: center; padding: 60px var(--gutter);
  color: var(--text-dim); font-size: 0.78em;
  border-top: 1px solid var(--border-subtle);
}
.footer a { color: var(--text-secondary); text-decoration: none; }
.footer a:hover { color: var(--accent); }
</style>
</head>
<body>

<div class="progress-bar" id="progressBar"></div>

<nav class="nav-dots" id="navDots">
  <button class="nav-dot active" data-label="Top" onclick="scrollToChapter(0)"></button>
  <button class="nav-dot" data-label="Problem" onclick="scrollToChapter(1)"></button>
  <button class="nav-dot" data-label="The Output" onclick="scrollToChapter(2)"></button>
  <button class="nav-dot" data-label="3D Datum View" onclick="scrollToChapter(3)"></button>
  <button class="nav-dot" data-label="Pipeline" onclick="scrollToChapter(4)"></button>
  <button class="nav-dot" data-label="Parser" onclick="scrollToChapter(5)"></button>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHAPTER 0: HERO
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="hero chapter" id="ch0">
  <div class="hero-bg"></div>
  <div class="hero-grid"></div>
  <div class="hero-content">
    <div class="hero-badge reveal">
      <span class="hero-badge-dot"></span>
      Universal Setup Sheet Generator &middot; Explainer
    </div>
    <h1 class="reveal delay-1">Raw G-code in.<br><span class="highlight">Beautiful setup sheets out.</span></h1>
    <p class="hero-sub reveal delay-2">
      Drop in any .nc file ‚Äî any CAM software, any post processor, even hand-written ‚Äî and get a clean, customizable, print-ready setup sheet. Automated. Consistent.
    </p>
    <div class="hero-stats reveal delay-3">
      <div class="hero-stat">
        <div class="hero-stat-val">~900</div>
        <div class="hero-stat-label">Lines of C#</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-val">6</div>
        <div class="hero-stat-label">Source Files</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-val">2</div>
        <div class="hero-stat-label">Phases</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-val">&lt;1s</div>
        <div class="hero-stat-label">Parse Time</div>
      </div>
    </div>
  </div>
  <div class="scroll-hint">
    Scroll to explore
    <svg width="16" height="24" viewBox="0 0 16 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M8 4v12M4 12l4 4 4-4"/>
    </svg>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHAPTER 1: THE PROBLEM
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="chapter" id="ch1">
  <div class="col">
    <div class="chapter-label reveal">01 ‚Äî The Problem</div>
    <h2 class="reveal delay-1">Setup sheets are<br>a time sink</h2>
    <p class="lead reveal delay-2">
      Every job needs a setup sheet. Every CAM system can export one. So what's the problem?
    </p>

    <div class="comparison reveal delay-3">
      <div class="compare-card bad">
        <div class="badge">The Status Quo</div>
        <h3>Edit, Export, Edit Again</h3>
        <p>Your CAM exports a setup sheet ‚Äî but it looks like it was made in 1998 and only covers that one post. Different CAM software? Different machine brand? You're reformatting by hand. Then the machinist tries the setup and wants a change ‚Äî totally reasonable ‚Äî but now you're updating the program <em>and</em> rebuilding the sheet. Every revision, every time. Across a shop running two or three different CAM packages on machines from different eras and different manufacturers, it adds up fast. The automated alternatives from third-party resellers? Thousands of dollars.</p>
        <div class="time">10‚Äì30 min per revision</div>
      </div>
      <div class="compare-card good">
        <div class="badge">This Tool</div>
        <h3>Regenerate in Seconds</h3>
        <p>Reads the G-code directly ‚Äî doesn't matter which CAM generated it. Machinist wants a change? Update the program, hit Generate again, done. Outputs an interactive HTML page ‚Äî editable cells, NC code preview, even a 3D STEP viewer. Point it at all your tool libraries ‚Äî it figures out which one to use from the G-code. Prints clean.</p>
        <div class="time">&lt; 3 sec to regenerate</div>
      </div>
    </div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHAPTER 2: THE OUTPUT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="chapter" id="ch2">
  <div class="col-wide">
    <div class="chapter-label reveal">02 ‚Äî The Output</div>
    <h2 class="reveal delay-1">This is what<br>you get</h2>
    <p class="lead reveal delay-2">
      A clean, interactive HTML page. Prints perfectly. Cycle through the themes below ‚Äî the layout stays consistent, the look is yours to pick.
    </p>

    <!-- Theme switcher -->
    <div class="theme-switcher reveal delay-3">
      <button class="theme-btn active-theme" data-theme="workshop" onclick="setSheetTheme('workshop')">Workshop</button>
      <button class="theme-btn" data-theme="blueprint" onclick="setSheetTheme('blueprint')">Blueprint</button>
      <button class="theme-btn" data-theme="midnight" onclick="setSheetTheme('midnight')">Midnight</button>
      <button class="theme-btn" data-theme="clean" onclick="setSheetTheme('clean')">Clean</button>
    </div>

    <!-- Mini setup sheet mockup (sanitized data) -->
    <div class="sheet-preview reveal delay-3" id="sheetPreview">
      <div class="sp-header" id="spHeader">
        <div class="sp-header-left">
          <div class="sp-label">Setup Sheet</div>
          <div class="sp-part">EX-7042</div>
        </div>
        <div class="sp-header-center">
          <div class="sp-machine-label">3-Axis Vertical</div>
          <div class="sp-machine">VMC-400</div>
        </div>
        <div class="sp-header-right">
          <div class="sp-rev">REV B</div>
          <div class="sp-date">2026-02-10</div>
        </div>
      </div>

      <div class="sp-info-row">
        <div class="sp-info"><span class="sp-info-label">Material</span><span class="sp-info-val">6061-T6 Aluminium</span></div>
        <div class="sp-info"><span class="sp-info-label">Programmer</span><span class="sp-info-val">H. Thomas</span></div>
        <div class="sp-info"><span class="sp-info-label">Fixture</span><span class="sp-info-val">6" Kurt Vise</span></div>
        <div class="sp-info"><span class="sp-info-label">Datum</span><span class="sp-info-val">G54 ‚Äî Top left corner</span></div>
      </div>

      <div class="sp-section-head">
        <span class="sp-section-num">1</span>
        <span>Toolpath Sequence</span>
        <span class="sp-tap-hint">tap a row to view G-code</span>
      </div>

      <table class="sp-table">
        <thead>
          <tr><th>T#</th><th>Description</th><th>Operation</th><th>RPM</th><th>Feed</th><th>Coolant</th><th>Min Z</th><th></th></tr>
        </thead>
        <tbody>
          <tr onclick="toggleGcodeRow(this)">
            <td class="sp-mono sp-bold">T1</td>
            <td>63mm Face Mill</td>
            <td class="sp-op">FACING</td>
            <td class="sp-mono">8,000</td>
            <td class="sp-mono">2,500</td>
            <td><span class="sp-coolant flood">Flood</span></td>
            <td class="sp-mono sp-depth">-0.5</td>
            <td class="sp-chevron">&#9662;</td>
          </tr>
          <tr class="sp-gcode-row"><td colspan="8"><div class="sp-gcode-expand">( FACING )<br><span class="sp-gcode-highlight">N120 T1 M6</span><br>N140 S8000 M3<br>N150 G43 H1 Z50. M8<br>N160 G0 Z2.<br>N170 G1 Z-0.5 F200.<br><span class="sp-gcode-highlight">N180 G1 X100. Y50. F2500.</span></div></td></tr>
          <tr onclick="toggleGcodeRow(this)">
            <td class="sp-mono sp-bold">T2</td>
            <td>16mm 3-Flute Endmill</td>
            <td class="sp-op">ROUGH POCKET</td>
            <td class="sp-mono">10,000</td>
            <td class="sp-mono">1,200</td>
            <td><span class="sp-coolant flood">Flood</span></td>
            <td class="sp-mono sp-depth">-18.0</td>
            <td class="sp-chevron">&#9662;</td>
          </tr>
          <tr class="sp-gcode-row"><td colspan="8"><div class="sp-gcode-expand">( POCKET )<br><span class="sp-gcode-highlight">N220 T2 M6</span><br>N230 S10000 M3<br>N240 G43 H2 Z50. M8<br>N260 G0 Z2.<br>N270 G1 Z-5. F300.<br><span class="sp-gcode-highlight">N280 G1 X60. Y30. F1200.</span></div></td></tr>
          <tr onclick="toggleGcodeRow(this)">
            <td class="sp-mono sp-bold">T3</td>
            <td>10mm Ball Nose</td>
            <td class="sp-op">FINISH PROFILE</td>
            <td class="sp-mono">12,000</td>
            <td class="sp-mono">3,000</td>
            <td><span class="sp-coolant tsc">TSC</span></td>
            <td class="sp-mono sp-depth">-22.5</td>
            <td class="sp-chevron">&#9662;</td>
          </tr>
          <tr class="sp-gcode-row"><td colspan="8"><div class="sp-gcode-expand">( FINISH PROFILE )<br><span class="sp-gcode-highlight">N340 T5 M6</span><br>N350 G0 G90 G55 X0. Y0.<br>N360 S12000 M3<br>N370 G43 H5 Z50. M88<br>N390 G1 Z-10. F100.<br><span class="sp-gcode-highlight">N400 G1 X80. Y40. F3000.</span></div></td></tr>
          <tr onclick="toggleGcodeRow(this)">
            <td class="sp-mono sp-bold">T8</td>
            <td>8.5mm Carbide Drill</td>
            <td class="sp-op">DRILL 4X</td>
            <td class="sp-mono">4,200</td>
            <td class="sp-mono">320</td>
            <td><span class="sp-coolant tsc">TSC</span></td>
            <td class="sp-mono sp-depth">-25.0</td>
            <td class="sp-chevron">&#9662;</td>
          </tr>
          <tr class="sp-gcode-row"><td colspan="8"><div class="sp-gcode-expand"><span class="sp-gcode-highlight">N440 T8 M6</span><br>N450 S4200 M3<br>N460 G43 H8 Z50. M88<br><span class="sp-gcode-highlight">N470 G81 Z-25. R2. F320.</span><br>N480 X32. Y6.<br>N490 X38. Y6.<br>N500 X32. Y14.<br>N510 X38. Y14.<br>N520 G80</div></td></tr>
          <tr onclick="toggleGcodeRow(this)">
            <td class="sp-mono sp-bold">T12</td>
            <td>M10x1.5 Spiral Tap</td>
            <td class="sp-op">TAP 4X</td>
            <td class="sp-mono">800</td>
            <td class="sp-mono">1,200</td>
            <td><span class="sp-coolant mist">Mist</span></td>
            <td class="sp-mono sp-depth">-18.0</td>
            <td class="sp-chevron">&#9662;</td>
          </tr>
          <tr class="sp-gcode-row"><td colspan="8"><div class="sp-gcode-expand"><span class="sp-gcode-highlight">N540 T12 M6</span><br>N550 S800 M3<br>N560 G43 H12 Z50. M7<br><span class="sp-gcode-highlight">N570 G84 Z-18. R2. F1200.</span><br>N580 X32. Y6.<br>N590 X38. Y6.<br>N600 X32. Y14.<br>N610 X38. Y14.<br>N620 G80</div></td></tr>
        </tbody>
      </table>

      <div class="sp-section-head">
        <span class="sp-section-num">2</span>
        <span>Setup Images</span>
      </div>
      <div class="sp-images">
        <div class="sp-fixture-img">
          <!-- SVG fixture illustration: part in vise with datum callout -->
          <svg viewBox="0 0 400 220" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%;">
            <!-- Table surface -->
            <rect x="20" y="175" width="360" height="12" rx="2" fill="var(--sp-muted)" opacity="0.2"/>
            <line x1="20" y1="175" x2="380" y2="175" stroke="var(--sp-border)" stroke-width="2"/>
            <!-- Vise base -->
            <rect x="60" y="148" width="280" height="27" rx="3" fill="var(--sp-muted)" opacity="0.25" stroke="var(--sp-border)" stroke-width="1"/>
            <!-- Fixed jaw -->
            <rect x="60" y="100" width="18" height="75" rx="2" fill="var(--sp-muted)" opacity="0.35" stroke="var(--sp-border)" stroke-width="1"/>
            <!-- Movable jaw -->
            <rect x="322" y="100" width="18" height="75" rx="2" fill="var(--sp-muted)" opacity="0.35" stroke="var(--sp-border)" stroke-width="1"/>
            <!-- Jaw serrations -->
            <line x1="64" y1="110" x2="64" y2="165" stroke="var(--sp-border)" stroke-width="0.5" stroke-dasharray="3,3"/>
            <line x1="72" y1="110" x2="72" y2="165" stroke="var(--sp-border)" stroke-width="0.5" stroke-dasharray="3,3"/>
            <line x1="328" y1="110" x2="328" y2="165" stroke="var(--sp-border)" stroke-width="0.5" stroke-dasharray="3,3"/>
            <line x1="336" y1="110" x2="336" y2="165" stroke="var(--sp-border)" stroke-width="0.5" stroke-dasharray="3,3"/>
            <!-- Stock block -->
            <rect x="78" y="70" width="244" height="78" rx="2" fill="var(--sp-accent)" opacity="0.15" stroke="var(--sp-accent)" stroke-width="1.5"/>
            <!-- Stock hatching -->
            <line x1="90" y1="70" x2="78" y2="82" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="120" y1="70" x2="78" y2="112" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="150" y1="70" x2="78" y2="142" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="180" y1="70" x2="84" y2="148" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="210" y1="70" x2="114" y2="148" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="240" y1="70" x2="144" y2="148" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="270" y1="70" x2="174" y2="148" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="300" y1="70" x2="204" y2="148" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="322" y1="78" x2="234" y2="148" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="322" y1="108" x2="264" y2="148" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <line x1="322" y1="138" x2="294" y2="148" stroke="var(--sp-accent)" stroke-width="0.4" opacity="0.3"/>
            <!-- Pocket feature -->
            <rect x="130" y="85" width="80" height="50" rx="2" fill="var(--sp-bg)" stroke="var(--sp-accent)" stroke-width="1" stroke-dasharray="4,2"/>
            <!-- Drill holes -->
            <circle cx="260" cy="95" r="5" fill="var(--sp-bg)" stroke="var(--sp-accent)" stroke-width="1"/>
            <circle cx="290" cy="95" r="5" fill="var(--sp-bg)" stroke="var(--sp-accent)" stroke-width="1"/>
            <circle cx="260" cy="125" r="5" fill="var(--sp-bg)" stroke="var(--sp-accent)" stroke-width="1"/>
            <circle cx="290" cy="125" r="5" fill="var(--sp-bg)" stroke="var(--sp-accent)" stroke-width="1"/>
            <!-- Datum origin (G54) -->
            <circle cx="78" cy="70" r="4" fill="none" stroke="#ff5c5c" stroke-width="2"/>
            <line x1="78" y1="70" x2="78" y2="42" stroke="#5cff5c" stroke-width="1.5" marker-end="url(#arrowG)"/>
            <line x1="78" y1="70" x2="110" y2="70" stroke="#ff5c5c" stroke-width="1.5" marker-end="url(#arrowR)"/>
            <!-- Datum label -->
            <rect x="84" y="30" width="34" height="16" rx="3" fill="var(--sp-accent)" opacity="0.9"/>
            <text x="101" y="42" text-anchor="middle" font-family="monospace" font-size="10" font-weight="bold" fill="white">G54</text>
            <!-- Dimension lines -->
            <line x1="78" y1="158" x2="322" y2="158" stroke="var(--sp-muted)" stroke-width="0.8" opacity="0.5"/>
            <text x="200" y="168" text-anchor="middle" font-family="monospace" font-size="9" fill="var(--sp-muted)" opacity="0.7">244.0 mm</text>
            <!-- Arrow markers -->
            <defs>
              <marker id="arrowR" viewBox="0 0 6 6" refX="5" refY="3" markerWidth="5" markerHeight="5" orient="auto"><path d="M0,0 L6,3 L0,6" fill="#ff5c5c"/></marker>
              <marker id="arrowG" viewBox="0 0 6 6" refX="3" refY="5" markerWidth="5" markerHeight="5" orient="auto"><path d="M0,6 L3,0 L6,6" fill="#5cff5c"/></marker>
            </defs>
          </svg>
        </div>
        <div class="sp-3d-container">
          <canvas id="miniViewer3d"></canvas>
          <div class="sp-3d-label">Drag to orbit</div>
        </div>
      </div>

      <div class="sp-footer" id="spFooter">
        <span>H. Thomas</span>
        <span>EX-7042 Rev B</span>
        <span>Page 1 of 1</span>
      </div>
    </div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHAPTER 3: 3D DATUM VIEW
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="chapter" id="ch3">
  <div class="col-wide">
    <div class="chapter-label reveal">03 ‚Äî The 3D View</div>
    <h2 class="reveal delay-1">Kill the<br>screengrab</h2>
    <p class="lead reveal delay-2">
      Today, setup sheets show datum locations with pasted screenshots from the CAM software. Flat, low-res, one angle only. If the machinist needs to see the other side? Too bad. The next step: an interactive 3D view of the stock, fixtures, and datum origins ‚Äî right inside the setup sheet.
    </p>

    <div class="callout reveal delay-3" style="border-left-color: var(--accent4);">
      <strong>How it works:</strong> You export a STEP file of the design stock and fixture geometry from your CAM software. The datum origin is carried with the STEP ‚Äî and if your CAM exports multiple work coordinate systems (G54, G55, G59...), those come along too. The tool parses the work offsets from the G-code, maps them to the coordinate systems in the STEP, and renders an interactive 3D view. The machinist at the PC can orbit, zoom, and inspect where each datum sits relative to the stock and fixturing ‚Äî no more guessing from a cropped screenshot. Drag the view below.
    </div>

    <!-- 3D viewer -->
    <div class="viewer-container reveal delay-3" id="viewerContainer">
      <div class="viewer-toolbar">
        <span class="viewer-toolbar-title">Interactive Setup View</span>
        <div class="viewer-controls">
          <button class="ex-btn ex-btn-wide viewer-btn" data-view="iso" onclick="setView('iso')">Iso</button>
          <button class="ex-btn ex-btn-wide viewer-btn" data-view="top" onclick="setView('top')">Top</button>
          <button class="ex-btn ex-btn-wide viewer-btn" data-view="front" onclick="setView('front')">Front</button>
          <button class="ex-btn ex-btn-wide viewer-btn" data-view="right" onclick="setView('right')">Right</button>
        </div>
      </div>
      <canvas id="viewer3d"></canvas>
      <div class="viewer-legend">
        <span class="legend-item"><span class="legend-swatch" style="background:#6c8aff"></span>Stock</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#4a4e5e"></span>Vise</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#ff5c5c"></span>X axis</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#5cff5c"></span>Y axis</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#5c8aff"></span>Z axis</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#ffcb5c"></span>G54</span>
        <span class="legend-item"><span class="legend-swatch" style="background:#cb6cff"></span>G55</span>
      </div>
    </div>

  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHAPTER 4: THE PIPELINE
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="chapter" id="ch4">
  <div class="col-wide">
    <div class="chapter-label reveal">04 ‚Äî Data Flow</div>
    <h2 class="reveal delay-1">From G-code<br>to setup sheet</h2>
    <p class="lead reveal delay-2">
      Three stages. Two inputs. One output.
    </p>

    <div class="pipeline reveal delay-3">
      <div class="pipe-stage">
        <span class="icon">üìÑ</span>
        <h4>.nc File</h4>
        <p>Raw G-code from any CAM software or hand-written</p>
      </div>
      <div class="pipe-arrow">‚Üí</div>
      <div class="pipe-stage">
        <span class="icon">üîç</span>
        <h4>Parser</h4>
        <p>Two-phase state machine extracts tools, speeds, feeds, coolant</p>
      </div>
      <div class="pipe-arrow">‚Üí</div>
      <div class="pipe-stage">
        <span class="icon">üîó</span>
        <h4>Merge</h4>
        <p>Auto-matches to the right tool library from your collection</p>
      </div>
      <div class="pipe-arrow">‚Üí</div>
      <div class="pipe-stage">
        <span class="icon">üìä</span>
        <h4>HTML Output</h4>
        <p>Interactive, print-ready setup sheet with editable cells, NC preview, and 3D viewer</p>
      </div>
    </div>

    <div class="callout reveal delay-4">
      <strong>Just tell it where your libraries live.</strong> Got three machines with three different tool libraries? Point the tool at all of them. It reads the G-code, identifies which machine it's for, and pulls from the right library automatically. No manual selection. The setup sheet still generates even without a library ‚Äî missing fields are highlighted yellow for manual entry.
    </div>

    <!-- Interactive tool library matcher -->
    <div class="lib-matcher reveal delay-4" id="libMatcher">
      <div class="lib-matcher-header">Library Auto-Match</div>
      <div class="lib-matcher-body">
        <div class="lib-matcher-row">
          <div>
            <div style="font-size:0.72em;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px;">G-code clues</div>
            <div class="lib-gcode-box" id="libGcode">
              <div style="color:var(--text-dim)">%</div>
              <div><span class="lib-clue" id="clue1">O1001 (VMC-400-POST)</span></div>
              <div style="color:var(--text-dim)">( T1 | 63MM FACEMILL | H1 )</div>
              <div style="color:var(--text-dim)">N100 G21</div>
              <div><span class="lib-clue" id="clue2">( MACHINE: VMC-400 )</span></div>
              <div style="color:var(--text-dim)">N110 G0 G17 G40 G49 G80 G90</div>
              <div><span class="lib-clue" id="clue3">N120 T1 M6</span></div>
            </div>
          </div>
          <div class="lib-matcher-arrow" id="libArrow">‚Üí</div>
          <div>
            <div style="font-size:0.72em;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px;">Your tool libraries</div>
            <div class="lib-cards">
              <div class="lib-card" id="lib1">
                <div class="lib-card-name">5-Axis HMC <span class="lib-match-tag" style="display:none" id="lib1tag">Match</span></div>
                <div class="lib-card-detail">42 tools &middot; /libs/hmc-500/</div>
              </div>
              <div class="lib-card" id="lib2">
                <div class="lib-card-name">3-Axis VMC <span class="lib-match-tag" style="display:none" id="lib2tag">&#10003; Match</span></div>
                <div class="lib-card-detail">28 tools &middot; /libs/vmc-400/</div>
              </div>
              <div class="lib-card" id="lib3">
                <div class="lib-card-name">Turning Center <span class="lib-match-tag" style="display:none" id="lib3tag">Match</span></div>
                <div class="lib-card-detail">16 tools &middot; /libs/lathe-200/</div>
              </div>
            </div>
          </div>
        </div>
        <div class="lib-matcher-explain" id="libExplain">
          Click <strong>Match</strong> to see how the tool identifies the right library from your G-code.
        </div>
        <div class="lib-matcher-controls">
          <button class="ex-btn ex-btn-wide" id="libMatchBtn" onclick="runLibMatch()">&#9654; Match</button>
          <button class="ex-btn ex-btn-wide" onclick="resetLibMatch()">Reset</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHAPTER 5: THE PARSER
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="chapter" id="ch5">
  <div class="col-wide">
    <div class="chapter-label reveal">05 ‚Äî The Parser</div>
    <h2 class="reveal delay-1">Step through<br>actual G-code</h2>
    <p class="lead reveal delay-2">
      Click any line to see what the parser does. Watch state accumulate across tool blocks. See exactly when data gets captured ‚Äî and when it's intentionally skipped.
    </p>

    <!-- Two-phase explanation -->
    <div class="concept-grid cols-2 reveal delay-3">
      <div class="concept-card">
        <div class="cc-icon" style="color:var(--accent5)">‚ë†</div>
        <h4>Phase 1 ‚Äî Pre-scan</h4>
        <p>Reads header comments to find tool descriptions. Many CAM systems write them as pipe-delimited lines: <code>( T1 | 63MM FACEMILL | H1 )</code>. Builds a lookup table before the real parsing begins.</p>
      </div>
      <div class="concept-card">
        <div class="cc-icon" style="color:var(--accent)">‚ë°</div>
        <h4>Phase 2 ‚Äî State Machine</h4>
        <p>Line-by-line walk tracking modal G-codes, spindle, coolant, offsets, and feed. When it hits a tool change (T## M6) or program end (M30), it <em>emits</em> the collected state as a tool record.</p>
      </div>
    </div>

    <!-- Interactive Explorer -->
    <div class="explorer-container reveal" id="explorerContainer">
      <div class="explorer-toolbar">
        <span class="explorer-toolbar-title">Interactive G-Code Explorer</span>
        <div class="explorer-controls">
          <button class="ex-btn" onclick="resetExplorer()" title="Reset">‚Ü∫</button>
          <button class="ex-btn" onclick="stepPrev()" title="Previous">‚óÄ</button>
          <button class="ex-btn" onclick="stepNext()" title="Next">‚ñ∂</button>
          <button class="ex-btn ex-btn-wide" id="playBtn" onclick="togglePlay()">‚ñ∂ Auto</button>
        </div>
      </div>
      <div class="explorer-body">
        <div class="gcode-listing" id="gcodeListing"></div>
        <div class="state-sidebar">
          <div class="state-sidebar-header">Parser State</div>
          <div class="state-cells" id="stateCells"></div>
        </div>
      </div>
      <div class="explain-panel" id="explainPanel"></div>
    </div>

    <!-- Extracted data table -->
    <div class="data-table-wrap reveal">
      <div class="data-table-header">Extracted Tool Data</div>
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th><th>Tool</th><th>Operation</th><th>RPM</th><th>Feed</th><th>Coolant</th><th>Offset</th><th>Min Z</th>
          </tr>
        </thead>
        <tbody id="extractedBody">
          <tr><td colspan="8" class="empty">Tap a line above to begin</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<footer class="footer">
  <p>Built by Hardy Thomas with <a href="https://claude.ai/claude-code">Claude Code</a></p>
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// G-CODE DATA ‚Äî each entry:
// [text, type, explanation, tag, stateChanges]
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const LINES = [
["%", "meta", "Program start marker ‚Äî standard G-code delimiter.", "ignore", null],
["O1001 (26C49050-TR01_REV-A-00 OP1)", "meta", "Program number and filename. The GUI extracts part number and revision from this using a regex.", "ignore", null],
["( T1 | 63MM FACEMILL | H1 | XY STL 0. | Z STL .1 )", "header", "<span class='explain-tag tag-phase1'>Phase 1</span> Pre-scan finds this pipe-delimited comment. Stores: T1 ‚Üí '63MM FACEMILL'.", "phase1", null],
["( T2 | 16MM ENDMILL | H2 | XY STL 0. | Z STL 0. )", "header", "<span class='explain-tag tag-phase1'>Phase 1</span> Stores: T2 ‚Üí '16MM ENDMILL'.", "phase1", null],
["( T5 | 10MM BALLNOSE | H5 | XY STL 0. | Z STL 0. )", "header", "<span class='explain-tag tag-phase1'>Phase 1</span> Stores: T5 ‚Üí '10MM BALLNOSE'. All three descriptions captured before real parsing begins.", "phase1", null],
["N100 G21", "meta", "Metric mode (millimeters). Parser doesn't track this ‚Äî it's a machine setup code.", "ignore", null],
["N110 G0 G17 G40 G49 G80 G90", "meta", "Safety line ‚Äî cancels tool comp (G40), length comp (G49), canned cycles (G80). Standard boilerplate.", "ignore", null],
["( FACING )", "comment", "<span class='explain-tag tag-state'>State</span> Standalone comment captured as pending operation name. Will attach to the next tool change.", "state", {pendingOp: "FACING"}],
["N120 T1 M6", "tool", "<span class='explain-tag tag-emit'>Emit</span> Tool change! T1 + M6 on same line. Parser starts a new tool block ‚Äî resets all state. Pending comment 'FACING' becomes this tool's operation name.", "emit", {tool: "T1", op: "FACING", rpm: "‚Äî", feed: "‚Äî", coolant: "Off", offset: "‚Äî", height: "‚Äî", minZ: "‚Äî", dir: "‚Äî", iVal: "‚Äî", jVal: "‚Äî"}],
["N130 G0 G90 G54 X0. Y0.", "offset", "<span class='explain-tag tag-state'>State</span> Rapid to start position. G54 work offset captured. G0 = rapid mode.", "state", {offset: "G54"}],
["N140 S8000 M3", "spindle", "<span class='explain-tag tag-state'>State</span> Spindle ON ‚Äî 8000 RPM clockwise (M3).", "state", {rpm: "8000", dir: "CW"}],
["N150 G43 H1 Z50. M8", "coolant", "<span class='explain-tag tag-state'>State</span> G43 H1 = height offset applied. M8 = flood coolant ON. Z50 is clearance ‚Äî not cutting.", "state", {height: "H1", coolant: "Flood"}],
["N160 G0 Z2.", "rapid", "Rapid approach to 2mm above part. G0 is still modal ‚Äî Z not tracked as cutting depth.", "ignore", null],
["N170 G1 Z-0.5 F200.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> Plunge to Z-0.5 at F200. But no X or Y on this line ‚Äî parser stores as fallback only. Lateral heuristic waits for a real cutting move.", "heuristic", {minZ: "-0.5"}],
["N180 G1 X100. Y50. F2500.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> <strong>Lateral feed captured!</strong> X and Y present ‚Äî F2500 is the real cutting feed. This is what goes on the setup sheet.", "heuristic", {feed: "F2500"}],
["N190 G1 X0. Y0.", "cut", "Continue cutting. Feed is modal (still 2500). No new state changes.", "ignore", null],
["N200 G0 Z50.", "rapid", "Rapid retract to clearance.", "ignore", null],
["N210 M5 M9", "meta", "Spindle stop + coolant off. Parser ignores M5 ‚Äî records the running direction, not the stop.", "ignore", null],
["( POCKET )", "comment", "<span class='explain-tag tag-state'>State</span> Standalone comment: 'POCKET' stored as pending operation name.", "state", {pendingOp: "POCKET"}],
["N220 T2 M6", "tool", "<span class='explain-tag tag-emit'>Emit</span> Tool change to T2! Parser EMITS T1 data (FACING, 8000 RPM, F2500, Flood, Z-0.5). Then resets for T2 with 'POCKET' as operation.", "emit", {tool: "T2", op: "POCKET", rpm: "‚Äî", feed: "‚Äî", coolant: "Off", offset: "G54", height: "‚Äî", minZ: "‚Äî", dir: "‚Äî", iVal: "‚Äî", jVal: "‚Äî", _emitPrev: true}],
["N230 G0 G90 G54 X30. Y20.", "offset", "<span class='explain-tag tag-state'>State</span> G54 work offset (same as before ‚Äî modal).", "state", {offset: "G54"}],
["N240 S10000 M3", "spindle", "<span class='explain-tag tag-state'>State</span> 10000 RPM clockwise.", "state", {rpm: "10000", dir: "CW"}],
["N250 G43 H2 Z50. T5", "offset", "<span class='explain-tag tag-state'>State</span> H2 height offset. T5 appears WITHOUT M6 ‚Äî this is next-tool staging. Tool carousel pre-loads T5, but it's not a tool change.", "state", {height: "H2"}],
["N260 G0 Z2.", "rapid", "Rapid approach.", "ignore", null],
["N270 G1 Z-5. F150.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> Plunge to Z-5 at F150. No X/Y ‚Äî stored as fallback only.", "heuristic", {minZ: "-5.0"}],
["N280 G1 X80. F1200.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> <strong>Lateral feed captured!</strong> X movement alone triggers the heuristic. F1200 recorded.", "heuristic", {feed: "F1200"}],
["N290 G1 Y40.", "cut", "Cutting in Y. Feed modal (1200).", "ignore", null],
["N300 G2 X30. Y20. I-25. J0.", "arc", "<span class='explain-tag tag-state'>State</span> Clockwise arc (G2)! I and J are arc center offsets ‚Äî I=-25 (X offset to center), J=0 (Y offset). The parser tracks these for arc moves.", "state", {iVal: "I-25", jVal: "J0"}],
["N310 G1 Y20.", "cut", "Linear move (G1). Back to straight-line cutting after the arc.", "state", {iVal: "‚Äî", jVal: "‚Äî"}],
["N320 G0 Z50.", "rapid", "Retract.", "ignore", null],
["N330 M5 M9", "meta", "Spindle and coolant off.", "ignore", null],
["( FINISH PROFILE )", "comment", "<span class='explain-tag tag-state'>State</span> 'FINISH PROFILE' stored as pending op name.", "state", {pendingOp: "FINISH PROFILE"}],
["N340 T5 M6", "tool", "<span class='explain-tag tag-emit'>Emit</span> T5 tool change! Emits T2 data (POCKET, 10000 RPM, F1200, Off, Z-5.0). T5 was pre-staged at N250.", "emit", {tool: "T5", op: "FINISH PROFILE", rpm: "‚Äî", feed: "‚Äî", coolant: "Off", offset: "G54", height: "‚Äî", minZ: "‚Äî", dir: "‚Äî", iVal: "‚Äî", jVal: "‚Äî", _emitPrev: true}],
["N350 G0 G90 G55 X0. Y0.", "offset", "<span class='explain-tag tag-state'>State</span> G55 ‚Äî different work offset! Parser captures the change from G54 to G55.", "state", {offset: "G55"}],
["N360 S12000 M3", "spindle", "<span class='explain-tag tag-state'>State</span> 12000 RPM ‚Äî fastest tool in the program.", "state", {rpm: "12000", dir: "CW"}],
["N370 G43 H5 Z50. M88", "coolant", "<span class='explain-tag tag-state'>State</span> H5 height offset. M88 = Through-Spindle Coolant (TSC). M-codes for TSC vary by machine brand.", "state", {height: "H5", coolant: "TSC"}],
["N380 G0 Z2.", "rapid", "Approach.", "ignore", null],
["N390 G1 Z-10. F100.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> Deepest plunge: Z-10. F100 fallback only ‚Äî no lateral.", "heuristic", {minZ: "-10.0"}],
["N400 G1 X60. Y30. F3000.", "feed", "<span class='explain-tag tag-heuristic'>Heuristic</span> <strong>Lateral feed captured!</strong> F3000 ‚Äî fastest feed (finish pass, light cuts).", "heuristic", {feed: "F3000"}],
["N410 G3 X20. Y30. I-20. J0.", "arc", "<span class='explain-tag tag-state'>State</span> Counter-clockwise arc (G3). I=-20, J=0 define the arc center relative to the start point.", "state", {iVal: "I-20", jVal: "J0"}],
["N420 G1 X0. Y0.", "cut", "Linear finish move.", "state", {iVal: "‚Äî", jVal: "‚Äî"}],
["N430 G0 Z50.", "rapid", "Final retract.", "ignore", null],
["N440 M5 M9", "meta", "Spindle and coolant off.", "ignore", null],
["N450 M30", "end", "<span class='explain-tag tag-emit'>Emit</span> Program end. Parser emits the final tool: T5, FINISH PROFILE, 12000 RPM, F3000, TSC, Z-10.0.", "emit", {_emitFinal: true}],
["%", "meta", "Program end marker.", "ignore", null],
];

// Emitted tool records (for the table)
const TOOLS = [
  {tool:"T1", desc:"63MM FACEMILL", op:"FACING", rpm:"8000", feed:"F2500", coolant:"Flood", offset:"G54", minZ:"-0.5", emitAfterLine: 19},
  {tool:"T2", desc:"16MM ENDMILL", op:"POCKET", rpm:"10000", feed:"F1200", coolant:"Off", offset:"G54", minZ:"-5.0", emitAfterLine: 32},
  {tool:"T5", desc:"10MM BALLNOSE", op:"FINISH PROFILE", rpm:"12000", feed:"F3000", coolant:"TSC", offset:"G55", minZ:"-10.0", emitAfterLine: 44},
];

// State fields displayed in sidebar
const STATE_FIELDS = [
  ["tool", "Tool"],
  ["op", "Operation"],
  ["rpm", "RPM"],
  ["feed", "Feed"],
  ["coolant", "Coolant"],
  ["offset", "Offset"],
  ["height", "Height"],
  ["dir", "Spindle"],
  ["minZ", "Min Z"],
  ["iVal", "I Value"],
  ["jVal", "J Value"],
];

// ‚ïê‚ïê‚ïê EXPLORER STATE ‚ïê‚ïê‚ïê
let activeLine = -1;
let playing = false;
let playTimer = null;
let currentState = {};

function freshState() {
  return {tool:"‚Äî", op:"‚Äî", rpm:"‚Äî", feed:"‚Äî", coolant:"‚Äî", offset:"‚Äî", height:"‚Äî", dir:"‚Äî", minZ:"‚Äî", iVal:"‚Äî", jVal:"‚Äî"};
}

function renderListing() {
  const el = document.getElementById('gcodeListing');
  el.innerHTML = '';
  LINES.forEach((line, i) => {
    const div = document.createElement('div');
    div.className = `gc-line t-${line[1]}${i === activeLine ? ' active' : ''}${i < activeLine ? ' past' : ''}`;
    div.innerHTML = `<span class="gc-ln">${i+1}</span><span class="gc-code">${escHtml(line[0])}</span>`;
    div.onclick = () => selectLine(i);
    el.appendChild(div);
  });
}

function selectLine(i) {
  activeLine = i;
  // Rebuild state from start
  currentState = freshState();
  let prevState = {};
  for (let j = 0; j <= i; j++) {
    const sc = LINES[j][4];
    if (sc) {
      for (const [k, v] of Object.entries(sc)) {
        if (k.startsWith('_') || k === 'pendingOp') continue;
        currentState[k] = v;
      }
    }
  }
  // Detect what changed on THIS line
  const thisChanges = LINES[i][4];
  const changedKeys = new Set();
  if (thisChanges) {
    for (const k of Object.keys(thisChanges)) {
      if (!k.startsWith('_') && k !== 'pendingOp') changedKeys.add(k);
    }
  }

  renderListing();
  renderState(changedKeys);
  renderExplain(i);
  renderExtracted(i);

  // Scroll active line within the listing container only (don't hijack page scroll)
  const lineEl = document.querySelectorAll('.gc-line')[i];
  const listing = document.getElementById('gcodeListing');
  if (lineEl && listing) {
    const lineTop = lineEl.offsetTop;
    const lineH = lineEl.offsetHeight;
    const listH = listing.clientHeight;
    const scrollTop = listing.scrollTop;
    if (lineTop < scrollTop) {
      listing.scrollTop = lineTop;
    } else if (lineTop + lineH > scrollTop + listH) {
      listing.scrollTop = lineTop + lineH - listH;
    }
  }
}

function renderState(changedKeys) {
  const el = document.getElementById('stateCells');
  el.innerHTML = STATE_FIELDS.map(([key, label]) => {
    const val = currentState[key] || '‚Äî';
    const changed = changedKeys.has(key) ? ' changed' : '';
    return `<div class="st-cell${changed}"><div class="st-val">${escHtml(val)}</div><div class="st-lbl">${label}</div></div>`;
  }).join('');
}

function renderExplain(i) {
  const el = document.getElementById('explainPanel');
  el.innerHTML = LINES[i][2];
  el.classList.add('visible');
}

function renderExtracted(lineIdx) {
  const tbody = document.getElementById('extractedBody');
  if (lineIdx < 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty">Tap a line above to begin</td></tr>';
    return;
  }
  tbody.innerHTML = '';
  let any = false;
  TOOLS.forEach((t, idx) => {
    const tr = document.createElement('tr');
    if (lineIdx >= t.emitAfterLine) {
      // Fully emitted
      tr.innerHTML = `<td>${idx+1}</td><td>${t.tool}</td><td>${t.op}</td><td>${t.rpm}</td><td>${t.feed}</td><td>${t.coolant}</td><td>${t.offset}</td><td>${t.minZ}</td>`;
      any = true;
    } else if (lineIdx >= (idx === 0 ? 8 : TOOLS[idx-1].emitAfterLine + 1)) {
      // Currently building
      tr.className = 'building';
      const s = currentState;
      tr.innerHTML = `<td>${idx+1}</td><td>${s.tool}</td><td>${s.op}</td><td>${s.rpm}</td><td>${s.feed}</td><td>${s.coolant}</td><td>${s.offset}</td><td>${s.minZ}</td>`;
      any = true;
    } else {
      tr.className = 'future';
      tr.innerHTML = `<td>${idx+1}</td><td>${t.tool}</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td>`;
      any = true;
    }
    tbody.appendChild(tr);
  });
  if (!any) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty">Parser hasn\'t reached any tool changes yet</td></tr>';
  }
}

function resetExplorer() {
  if (playing) togglePlay();
  activeLine = -1;
  currentState = freshState();
  renderListing();
  document.getElementById('stateCells').innerHTML = STATE_FIELDS.map(([key, label]) =>
    `<div class="st-cell"><div class="st-val">‚Äî</div><div class="st-lbl">${label}</div></div>`
  ).join('');
  document.getElementById('explainPanel').classList.remove('visible');
  document.getElementById('extractedBody').innerHTML = '<tr><td colspan="8" class="empty">Tap a line above to begin</td></tr>';
}

function stepNext() {
  if (playing) togglePlay();
  if (activeLine < LINES.length - 1) selectLine(activeLine + 1);
  else if (activeLine < 0) selectLine(0);
}

function stepPrev() {
  if (playing) togglePlay();
  if (activeLine > 0) selectLine(activeLine - 1);
  else if (activeLine < 0) selectLine(0);
}

function togglePlay() {
  playing = !playing;
  const btn = document.getElementById('playBtn');
  if (playing) {
    btn.innerHTML = '‚è∏ Pause';
    btn.classList.add('active');
    if (activeLine < 0) activeLine = -1;
    playTimer = setInterval(() => {
      if (activeLine >= LINES.length - 1) { togglePlay(); return; }
      selectLine(activeLine + 1);
    }, 1100);
  } else {
    btn.innerHTML = '‚ñ∂ Auto';
    btn.classList.remove('active');
    clearInterval(playTimer);
  }
}

function escHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

// ‚ïê‚ïê‚ïê SCROLL REVEAL ‚ïê‚ïê‚ïê
const revealObserver = new IntersectionObserver((entries) => {
  entries.forEach(e => {
    if (e.isIntersecting) {
      e.target.classList.add('visible');
    }
  });
}, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));

// ‚ïê‚ïê‚ïê TOOLPATH G-CODE TOGGLE ‚ïê‚ïê‚ïê
function toggleGcodeRow(row) {
  const gcodeRow = row.nextElementSibling;
  if (!gcodeRow || !gcodeRow.classList.contains('sp-gcode-row')) return;
  const expand = gcodeRow.querySelector('.sp-gcode-expand');
  const isOpen = expand.classList.contains('open');
  // Close all others first
  document.querySelectorAll('.sp-gcode-expand.open').forEach(el => el.classList.remove('open'));
  document.querySelectorAll('.sp-table tbody tr.sp-active').forEach(el => el.classList.remove('sp-active'));
  if (!isOpen) {
    expand.classList.add('open');
    row.classList.add('sp-active');
  }
}

// ‚ïê‚ïê‚ïê AUTO-START PARSER ‚ïê‚ïê‚ïê
let parserAutoStarted = false;
const parserSection = document.getElementById('ch5');
if (parserSection) {
  const parserObserver = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting && !parserAutoStarted && !playing) {
        parserAutoStarted = true;
        setTimeout(() => togglePlay(), 600);
      }
      if (!e.isIntersecting && playing) {
        togglePlay();
      }
    });
  }, { threshold: 0.1 });
  parserObserver.observe(parserSection);
}

// ‚ïê‚ïê‚ïê TOOL LIBRARY MATCHER ‚ïê‚ïê‚ïê
let libMatchRunning = false;
function runLibMatch() {
  if (libMatchRunning) return;
  libMatchRunning = true;
  resetLibMatch();
  const steps = [
    { delay: 400, fn: () => {
      document.getElementById('clue1').classList.add('active');
      document.getElementById('libExplain').innerHTML = '<strong>Step 1:</strong> Program header mentions "VMC-400-POST" ‚Äî that\'s a post processor identifier.';
    }},
    { delay: 1400, fn: () => {
      document.getElementById('clue2').classList.add('active');
      document.getElementById('libExplain').innerHTML = '<strong>Step 2:</strong> Comment "MACHINE: VMC-400" confirms the machine name. Two clues pointing the same way.';
    }},
    { delay: 2600, fn: () => {
      document.getElementById('libArrow').classList.add('matched');
      document.getElementById('libArrow').textContent = '‚Üí VMC-400 ‚Üí';
      document.getElementById('lib1').classList.add('dimmed');
      document.getElementById('lib3').classList.add('dimmed');
      document.getElementById('lib2').classList.add('matched');
      document.getElementById('lib2tag').style.display = 'inline';
      document.getElementById('libExplain').innerHTML = '<strong>Matched:</strong> "VMC-400" maps to the <strong>3-Axis VMC</strong> library (28 tools). Tool numbers from the G-code (T1, T2, T5) are looked up in this library to get diameters, holders, and stickout values.';
      libMatchRunning = false;
    }}
  ];
  steps.forEach(s => setTimeout(s.fn, s.delay));
}
function resetLibMatch() {
  libMatchRunning = false;
  document.querySelectorAll('.lib-clue').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.lib-card').forEach(c => { c.classList.remove('matched','dimmed'); });
  document.querySelectorAll('.lib-match-tag').forEach(t => t.style.display = 'none');
  const arrow = document.getElementById('libArrow');
  if (arrow) { arrow.classList.remove('matched'); arrow.textContent = '‚Üí'; }
  document.getElementById('libExplain').innerHTML = 'Click <strong>Match</strong> to see how the tool identifies the right library from your G-code.';
}

// ‚ïê‚ïê‚ïê PROGRESS BAR ‚ïê‚ïê‚ïê
function updateProgress() {
  const h = document.documentElement.scrollHeight - window.innerHeight;
  const p = h > 0 ? (window.scrollY / h) * 100 : 0;
  document.getElementById('progressBar').style.width = p + '%';
}
window.addEventListener('scroll', updateProgress, {passive: true});

// ‚ïê‚ïê‚ïê NAV DOTS ‚ïê‚ïê‚ïê
const chapters = document.querySelectorAll('.chapter');
const dots = document.querySelectorAll('.nav-dot');

function scrollToChapter(i) {
  chapters[i].scrollIntoView({behavior:'smooth'});
}

const chapterObserver = new IntersectionObserver((entries) => {
  entries.forEach(e => {
    if (e.isIntersecting) {
      const idx = Array.from(chapters).indexOf(e.target);
      dots.forEach((d, i) => d.classList.toggle('active', i === idx));
    }
  });
}, { threshold: 0.3 });

chapters.forEach(ch => chapterObserver.observe(ch));

// ‚ïê‚ïê‚ïê SHEET THEME SWITCHER ‚ïê‚ïê‚ïê
const themeBgColors = { workshop: '#f4f2ed', blueprint: '#0c1929', midnight: '#13151e', clean: '#ffffff' };
const themeGridColors = {
  workshop: ['#d5d0c8', '#e8e5dd', 0.4],
  blueprint: ['#1a3352', '#0f1f35', 0.5],
  midnight: ['#1e2133', '#13151e', 0.5],
  clean: ['#e5e7eb', '#f3f4f6', 0.3]
};
const themeViseColors = {
  workshop: '#5c6370', blueprint: '#3a5070', midnight: '#4a4e5e', clean: '#6b7280'
};
function setSheetTheme(theme) {
  const preview = document.getElementById('sheetPreview');
  preview.classList.remove('workshop', 'blueprint', 'midnight', 'clean');
  if (theme !== 'workshop') preview.classList.add(theme);
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active-theme'));
  document.querySelector(`.theme-btn[data-theme="${theme}"]`)?.classList.add('active-theme');
  if (window._miniScene) {
    const c = themeBgColors[theme] || '#f4f2ed';
    window._miniScene.background.set(c);
    if (window._miniPocketMat) window._miniPocketMat.color.set(c);
    if (window._miniHoleMat) window._miniHoleMat.color.set(c);
    if (window._miniGrid) {
      const g = themeGridColors[theme] || themeGridColors.workshop;
      window._miniGrid.material.opacity = g[2];
    }
    if (window._miniViseMat) window._miniViseMat.color.set(themeViseColors[theme] || '#5c6370');
  }
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
renderListing();
resetExplorer();
</script>

<!-- Three.js for 3D datum viewer -->
<script type="importmap">
{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/" } }
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

const canvas = document.getElementById('viewer3d');
if (canvas) {
  const container = document.getElementById('viewerContainer');
  const w = canvas.clientWidth || 800;
  const h = canvas.clientHeight || 420;

  // Scene
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0c12);
  scene.fog = new THREE.Fog(0x0a0c12, 400, 800);

  // Camera
  const camera = new THREE.PerspectiveCamera(35, w / h, 0.1, 1000);
  camera.position.set(180, 140, 200);

  // Renderer
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setSize(w, h);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;

  // Controls
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;
  controls.target.set(40, 10, 20);
  controls.minDistance = 80;
  controls.maxDistance = 500;
  controls.update();

  // Lights
  const ambient = new THREE.AmbientLight(0x404060, 1.2);
  scene.add(ambient);
  const dirLight = new THREE.DirectionalLight(0xffffff, 1.8);
  dirLight.position.set(100, 150, 80);
  dirLight.castShadow = true;
  dirLight.shadow.mapSize.set(1024, 1024);
  dirLight.shadow.camera.near = 10;
  dirLight.shadow.camera.far = 400;
  dirLight.shadow.camera.left = -150;
  dirLight.shadow.camera.right = 150;
  dirLight.shadow.camera.top = 150;
  dirLight.shadow.camera.bottom = -150;
  scene.add(dirLight);
  const fillLight = new THREE.DirectionalLight(0x6c8aff, 0.3);
  fillLight.position.set(-80, 40, -60);
  scene.add(fillLight);

  // Ground grid
  const gridHelper = new THREE.GridHelper(300, 30, 0x1e2133, 0x13151e);
  gridHelper.position.y = -30;
  scene.add(gridHelper);

  // ‚îÄ‚îÄ‚îÄ VISE (base + fixed jaw + movable jaw) ‚îÄ‚îÄ‚îÄ
  const viseMat = new THREE.MeshStandardMaterial({ color: 0x5c6370, roughness: 0.6, metalness: 0.6 });
  // Base
  const viseBase = new THREE.Mesh(new THREE.BoxGeometry(120, 18, 70), viseMat);
  viseBase.position.set(40, -21, 20);
  viseBase.castShadow = true; viseBase.receiveShadow = true;
  scene.add(viseBase);
  // Fixed jaw
  const fixedJaw = new THREE.Mesh(new THREE.BoxGeometry(120, 30, 8), viseMat);
  fixedJaw.position.set(40, -6, -11);
  fixedJaw.castShadow = true;
  scene.add(fixedJaw);
  // Movable jaw
  const moveJaw = new THREE.Mesh(new THREE.BoxGeometry(120, 30, 8), viseMat);
  moveJaw.position.set(40, -6, 51);
  moveJaw.castShadow = true;
  scene.add(moveJaw);

  // ‚îÄ‚îÄ‚îÄ STOCK BLOCK ‚îÄ‚îÄ‚îÄ
  const stockMat = new THREE.MeshStandardMaterial({ color: 0x7aa2f7, roughness: 0.3, metalness: 0.4, transparent: true, opacity: 0.7 });
  const stock = new THREE.Mesh(new THREE.BoxGeometry(100, 30, 40), stockMat);
  stock.position.set(40, 6, 20);
  stock.castShadow = true; stock.receiveShadow = true;
  scene.add(stock);

  // Stock wireframe
  const stockWire = new THREE.LineSegments(
    new THREE.EdgesGeometry(new THREE.BoxGeometry(100, 30, 40)),
    new THREE.LineBasicMaterial({ color: 0x8ca8ff, transparent: true, opacity: 0.5 })
  );
  stockWire.position.copy(stock.position);
  scene.add(stockWire);

  // ‚îÄ‚îÄ‚îÄ DATUM ARROW HELPER ‚îÄ‚îÄ‚îÄ
  function makeDatum(label, color, position) {
    const group = new THREE.Group();
    group.position.copy(position);

    const len = 25;
    const colors = [0xff5c5c, 0x5cff5c, 0x5c8aff]; // X, Y, Z
    const dirs = [new THREE.Vector3(1,0,0), new THREE.Vector3(0,1,0), new THREE.Vector3(0,0,1)];
    dirs.forEach((dir, i) => {
      const arrow = new THREE.ArrowHelper(dir, new THREE.Vector3(0,0,0), len, colors[i], 5, 3);
      group.add(arrow);
    });

    // Origin sphere
    const sphere = new THREE.Mesh(
      new THREE.SphereGeometry(2.5, 16, 16),
      new THREE.MeshStandardMaterial({ color, emissive: color, emissiveIntensity: 0.5 })
    );
    group.add(sphere);

    // Label sprite
    const cvs = document.createElement('canvas');
    cvs.width = 128; cvs.height = 48;
    const ctx = cvs.getContext('2d');
    ctx.fillStyle = '#' + color.toString(16).padStart(6, '0');
    ctx.font = 'bold 32px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(label, 64, 34);
    const tex = new THREE.CanvasTexture(cvs);
    const spriteMat = new THREE.SpriteMaterial({ map: tex, transparent: true });
    const sprite = new THREE.Sprite(spriteMat);
    sprite.scale.set(24, 9, 1);
    sprite.position.set(0, 30, 0);
    group.add(sprite);

    scene.add(group);
    return group;
  }

  // G54 ‚Äî top-left corner of stock (common datum placement)
  const g54 = makeDatum('G54', 0xffcb5c, new THREE.Vector3(-10, 21, 0));

  // G55 ‚Äî opposite corner (for second op / flip)
  const g55 = makeDatum('G55', 0xcb6cff, new THREE.Vector3(90, 21, 40));

  // ‚îÄ‚îÄ‚îÄ CAMERA VIEWS ‚îÄ‚îÄ‚îÄ
  window.setView = function(view) {
    document.querySelectorAll('.viewer-btn').forEach(b => b.classList.remove('active-view'));
    document.querySelector(`.viewer-btn[data-view="${view}"]`)?.classList.add('active-view');

    let pos, target = new THREE.Vector3(40, 10, 20);
    switch(view) {
      case 'top':   pos = new THREE.Vector3(40, 250, 20); break;
      case 'front': pos = new THREE.Vector3(40, 30, 200); break;
      case 'right': pos = new THREE.Vector3(250, 30, 20); break;
      default:      pos = new THREE.Vector3(180, 140, 200); break;
    }
    // Animate
    const start = camera.position.clone();
    const startTarget = controls.target.clone();
    let t = 0;
    function animStep() {
      t += 0.04;
      if (t > 1) t = 1;
      const ease = 1 - Math.pow(1 - t, 3); // ease out cubic
      camera.position.lerpVectors(start, pos, ease);
      controls.target.lerpVectors(startTarget, target, ease);
      controls.update();
      if (t < 1) requestAnimationFrame(animStep);
    }
    animStep();
  };

  // ‚îÄ‚îÄ‚îÄ ANIMATE ‚îÄ‚îÄ‚îÄ
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // ‚îÄ‚îÄ‚îÄ RESIZE ‚îÄ‚îÄ‚îÄ
  const ro = new ResizeObserver(() => {
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h, false);
  });
  ro.observe(canvas);
}

// ‚îÄ‚îÄ‚îÄ MINI 3D VIEWER (in setup sheet preview) ‚îÄ‚îÄ‚îÄ
const miniCanvas = document.getElementById('miniViewer3d');
if (miniCanvas) {
  const mw = miniCanvas.clientWidth || 400;
  const mh = miniCanvas.clientHeight || 250;

  const mScene = new THREE.Scene();
  mScene.background = new THREE.Color(0xf4f2ed);
  window._miniScene = mScene;

  const mCamera = new THREE.PerspectiveCamera(30, mw / mh, 0.1, 500);
  mCamera.position.set(90, 70, 100);

  const mRenderer = new THREE.WebGLRenderer({ canvas: miniCanvas, antialias: true });
  mRenderer.setSize(mw, mh);
  mRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  mRenderer.shadowMap.enabled = true;

  const mControls = new OrbitControls(mCamera, mRenderer.domElement);
  mControls.enableDamping = true;
  mControls.dampingFactor = 0.08;
  mControls.target.set(20, 5, 10);
  mControls.minDistance = 50;
  mControls.maxDistance = 300;
  mControls.enableZoom = true;
  mControls.update();

  // Lights
  mScene.add(new THREE.AmbientLight(0x404060, 1.4));
  const mDir = new THREE.DirectionalLight(0xffffff, 1.5);
  mDir.position.set(60, 80, 50);
  mDir.castShadow = true;
  mScene.add(mDir);
  mScene.add(new THREE.DirectionalLight(0x6c8aff, 0.3).translateX(-40));

  // Grid
  const mGrid = new THREE.GridHelper(150, 15, 0xd5d0c8, 0xe8e5dd);
  mGrid.material.opacity = 0.4;
  mGrid.material.transparent = true;
  mGrid.position.y = -16;
  mScene.add(mGrid);
  window._miniGrid = mGrid;

  // Vise ‚Äî gunmetal grey, clearly distinct from stock
  const mViseMat = new THREE.MeshStandardMaterial({ color: 0x5c6370, roughness: 0.6, metalness: 0.6 });
  window._miniViseMat = mViseMat;
  const mViseBase = new THREE.Mesh(new THREE.BoxGeometry(60, 9, 35), mViseMat);
  mViseBase.position.set(20, -11.5, 10);
  mViseBase.castShadow = true;
  mScene.add(mViseBase);
  const mFixedJaw = new THREE.Mesh(new THREE.BoxGeometry(60, 15, 4), mViseMat);
  mFixedJaw.position.set(20, -3, -6);
  mScene.add(mFixedJaw);
  const mMoveJaw = new THREE.Mesh(new THREE.BoxGeometry(60, 15, 4), mViseMat);
  mMoveJaw.position.set(20, -3, 26);
  mScene.add(mMoveJaw);

  // Stock ‚Äî aluminium blue, semi-transparent, clearly distinct from vise
  const mStockMat = new THREE.MeshStandardMaterial({ color: 0x7aa2f7, roughness: 0.3, metalness: 0.4, transparent: true, opacity: 0.7 });
  const mStock = new THREE.Mesh(new THREE.BoxGeometry(50, 15, 20), mStockMat);
  mStock.position.set(20, 3.5, 10);
  mStock.castShadow = true;
  mScene.add(mStock);

  // Stock wireframe
  const mStockWire = new THREE.LineSegments(
    new THREE.EdgesGeometry(new THREE.BoxGeometry(50, 15, 20)),
    new THREE.LineBasicMaterial({ color: 0x8ca8ff, transparent: true, opacity: 0.4 })
  );
  mStockWire.position.copy(mStock.position);
  mScene.add(mStockWire);

  // Pocket cavity (color matches scene background to simulate cut-away)
  const mPocketMat = new THREE.MeshStandardMaterial({ color: 0xf4f2ed, roughness: 0.8, metalness: 0.1 });
  window._miniPocketMat = mPocketMat;
  const mPocket = new THREE.Mesh(new THREE.BoxGeometry(20, 10, 12), mPocketMat);
  mPocket.position.set(10, 6.5, 8);
  mScene.add(mPocket);

  // Drill holes (4 cylinders)
  const mHoleMat = new THREE.MeshStandardMaterial({ color: 0xf4f2ed, roughness: 0.9 });
  window._miniHoleMat = mHoleMat;
  const holeGeo = new THREE.CylinderGeometry(1.5, 1.5, 16, 12);
  [[32, 6], [38, 6], [32, 14], [38, 14]].forEach(([x, z]) => {
    const hole = new THREE.Mesh(holeGeo, mHoleMat);
    hole.position.set(x, 4, z);
    mScene.add(hole);
  });

  // Datum G54
  const mDatumGroup = new THREE.Group();
  mDatumGroup.position.set(-5, 11, 0);
  const dLen = 12;
  const dColors = [0xff5c5c, 0x5cff5c, 0x5c8aff];
  const dDirs = [new THREE.Vector3(1,0,0), new THREE.Vector3(0,1,0), new THREE.Vector3(0,0,1)];
  dDirs.forEach((dir, i) => {
    mDatumGroup.add(new THREE.ArrowHelper(dir, new THREE.Vector3(0,0,0), dLen, dColors[i], 3, 2));
  });
  mDatumGroup.add(new THREE.Mesh(
    new THREE.SphereGeometry(1.5, 12, 12),
    new THREE.MeshStandardMaterial({ color: 0xffcb5c, emissive: 0xffcb5c, emissiveIntensity: 0.5 })
  ));
  // Label
  const mLblCvs = document.createElement('canvas');
  mLblCvs.width = 96; mLblCvs.height = 36;
  const mLblCtx = mLblCvs.getContext('2d');
  mLblCtx.fillStyle = '#ffcb5c';
  mLblCtx.font = 'bold 24px monospace';
  mLblCtx.textAlign = 'center';
  mLblCtx.fillText('G54', 48, 26);
  const mLblTex = new THREE.CanvasTexture(mLblCvs);
  const mLblSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: mLblTex, transparent: true }));
  mLblSprite.scale.set(12, 4.5, 1);
  mLblSprite.position.set(0, 16, 0);
  mDatumGroup.add(mLblSprite);
  mScene.add(mDatumGroup);

  // Slow auto-rotate
  function mAnimate() {
    requestAnimationFrame(mAnimate);
    if (!mControls._isDragging) {
      mDatumGroup.parent && (mScene.rotation.y += 0.002);
    }
    mControls.update();
    mRenderer.render(mScene, mCamera);
  }
  // Auto-rotate the whole scene gently
  let mAutoRotate = true;
  mControls.addEventListener('start', () => { mAutoRotate = false; });

  function mAnimLoop() {
    requestAnimationFrame(mAnimLoop);
    if (mAutoRotate) mScene.rotation.y += 0.003;
    mControls.update();
    mRenderer.render(mScene, mCamera);
  }
  mAnimLoop();

  // Resize
  const mRo = new ResizeObserver(() => {
    const w = miniCanvas.clientWidth;
    const h = miniCanvas.clientHeight;
    if (w && h) {
      mCamera.aspect = w / h;
      mCamera.updateProjectionMatrix();
      mRenderer.setSize(w, h, false);
    }
  });
  mRo.observe(miniCanvas);
}
</script>
</body>
</html>
